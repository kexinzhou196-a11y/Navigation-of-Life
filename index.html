<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>ç”Ÿå‘½å¯¼èˆª - å¥åº·ä¸äººç”Ÿè§„åˆ’</title>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
--bg:#FAF6F1;--card:#FFFFFF;
--glass:rgba(120,90,60,0.04);--glass-border:rgba(120,90,60,0.10);
--cyan:#2A9D8F;--coral:#E76F51;--gold:#E9A820;--green:#40916C;--purple:#7B68A8;
--lavender:#9381BE;--orange:#E07A3A;--blue:#4A8FBF;
--text:#3A3028;--text2:rgba(58,48,40,0.6);--text3:rgba(58,48,40,0.3);
--font:-apple-system,BlinkMacSystemFont,'Segoe UI','PingFang SC','Hiragino Sans GB','Microsoft YaHei',sans-serif;
--mono:'SF Mono','Menlo','Consolas',monospace,-apple-system,BlinkMacSystemFont,'Segoe UI','PingFang SC','Hiragino Sans GB','Microsoft YaHei',sans-serif;
--radius:14px;--nav-h:68px;--header-h:52px;
}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:var(--font);-webkit-tap-highlight-color:transparent;overscroll-behavior:none}
body{display:flex;justify-content:center;align-items:stretch}
#app{width:100%;max-width:430px;height:100dvh;display:flex;flex-direction:column;position:relative;overflow:hidden}
#starfield{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none}
.app-header{height:var(--header-h);min-height:var(--header-h);display:flex;align-items:center;justify-content:center;position:relative;z-index:10;backdrop-filter:blur(16px);background:rgba(250,246,241,0.85);border-bottom:1px solid var(--glass-border)}
.app-title{font-size:20px;font-weight:700;background:linear-gradient(135deg,var(--cyan),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:2px}
.pages-container{flex:1;position:relative;overflow:hidden;z-index:5}
.page{position:absolute;top:0;left:0;width:100%;height:100%;overflow-y:auto;overflow-x:hidden;padding:14px 12px 20px;opacity:0;transform:translateX(30px);transition:opacity 0.35s ease,transform 0.35s ease;pointer-events:none;scrollbar-width:none;-ms-overflow-style:none}
.page::-webkit-scrollbar{display:none}
.page.active{opacity:1;transform:translateX(0);pointer-events:auto}
.page.exit-left{opacity:0;transform:translateX(-30px)}
.bottom-nav{height:var(--nav-h);min-height:var(--nav-h);display:flex;align-items:center;justify-content:space-around;background:rgba(250,246,241,0.92);backdrop-filter:blur(20px);border-top:1px solid var(--glass-border);position:relative;z-index:10;padding-bottom:env(safe-area-inset-bottom)}
.nav-item{display:flex;flex-direction:column;align-items:center;gap:3px;padding:6px 12px;cursor:pointer;transition:all 0.3s ease;position:relative;-webkit-user-select:none;user-select:none}
.nav-item:active{transform:scale(0.92)}
.nav-item .nav-icon{font-size:22px;transition:transform 0.3s ease}
.nav-item .nav-label{font-size:10px;color:var(--text3);transition:color 0.3s ease;white-space:nowrap}
.nav-item.active .nav-icon{transform:scale(1.1)}
.nav-item.active .nav-label{color:var(--cyan)}
.nav-item.active::after{content:'';position:absolute;bottom:2px;width:4px;height:4px;border-radius:50%;background:var(--cyan);box-shadow:0 0 8px var(--cyan)}
.card{background:var(--card);border:1px solid var(--glass-border);border-radius:var(--radius);padding:14px 16px;backdrop-filter:blur(16px);transition:transform 0.3s ease,box-shadow 0.3s ease;box-shadow:0 2px 8px rgba(120,90,60,0.06)}
.card:active{transform:scale(0.98)}
.section-title{font-size:15px;font-weight:600;color:var(--text);margin:16px 0 10px;display:flex;align-items:center;gap:6px}
.section-title:first-child{margin-top:4px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}

/* Device cards */
.device-scroll{display:flex;gap:10px;overflow-x:auto;padding:4px 0 8px;scrollbar-width:none;-ms-overflow-style:none}
.device-scroll::-webkit-scrollbar{display:none}
.device-card{min-width:120px;padding:12px;border-radius:12px;background:var(--card);border:1px solid var(--glass-border);display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer;transition:all 0.3s ease;flex-shrink:0;box-shadow:0 1px 4px rgba(120,90,60,0.05)}
.device-card:active{transform:scale(0.96)}
.device-card.connected{border-color:rgba(64,145,108,0.3);box-shadow:0 0 12px rgba(64,145,108,0.08)}
.device-card .dev-icon{font-size:28px}
.device-card .dev-name{font-size:11px;color:var(--text2);text-align:center;white-space:nowrap}
.device-card .dev-status{font-size:10px;color:var(--text3);display:flex;align-items:center;gap:3px}
.device-card.connected .dev-status{color:var(--green)}
.device-card .sync-btn{font-size:10px;padding:4px 10px;border-radius:20px;border:1px solid var(--cyan);color:var(--cyan);background:transparent;cursor:pointer;transition:all 0.3s ease}
.device-card .sync-btn:active{background:var(--cyan);color:#fff}
.device-card.connected .sync-btn{border-color:var(--green);color:var(--green)}
.device-card.connecting .sync-btn{border-color:var(--gold);color:var(--gold);animation:pulse-border 1s infinite}
@keyframes pulse-border{0%,100%{opacity:1}50%{opacity:0.5}}

/* Health metric cards */
.metric-card{padding:12px;position:relative;overflow:hidden}
.metric-card .metric-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.metric-card .metric-icon{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px}
.metric-card .metric-trend{font-size:12px;display:flex;align-items:center;gap:2px}
.metric-card .metric-value{font-family:var(--mono);font-size:26px;font-weight:800;letter-spacing:1px;line-height:1.1}
.metric-card .metric-unit{font-size:11px;color:var(--text2);font-weight:400;margin-left:2px}
.metric-card .metric-label{font-size:11px;color:var(--text2);margin-top:2px}
.metric-card .sparkline-wrap{height:32px;margin-top:6px}
.metric-card .metric-time{font-size:9px;color:var(--text3);margin-top:4px}

/* Modal */
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:100;opacity:0;pointer-events:none;transition:opacity 0.3s ease;display:flex;align-items:flex-end;justify-content:center}
.modal-overlay.show{opacity:1;pointer-events:auto}
.modal-sheet{width:100%;max-width:430px;max-height:85vh;background:#FFFCF8;border-radius:20px 20px 0 0;transform:translateY(100%);transition:transform 0.4s cubic-bezier(0.32,0.72,0,1);overflow-y:auto;scrollbar-width:none;padding:0 16px 24px}
.modal-sheet::-webkit-scrollbar{display:none}
.modal-overlay.show .modal-sheet{transform:translateY(0)}
.modal-handle{width:36px;height:4px;border-radius:2px;background:rgba(120,90,60,0.2);margin:10px auto 16px}
.modal-title{font-size:17px;font-weight:600;text-align:center;margin-bottom:16px}
.form-group{margin-bottom:14px}
.form-label{font-size:12px;color:var(--text2);margin-bottom:5px;display:block}
.form-input{width:100%;padding:10px 14px;background:rgba(120,90,60,0.04);border:1px solid var(--glass-border);border-radius:10px;color:var(--text);font-size:14px;font-family:var(--font);outline:none;transition:border-color 0.3s}
.form-input:focus{border-color:var(--cyan)}
.form-select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='rgba(58,48,40,0.6)' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.form-check-group{display:flex;flex-wrap:wrap;gap:8px}
.form-check{padding:6px 12px;border-radius:20px;border:1px solid var(--glass-border);font-size:12px;color:var(--text2);cursor:pointer;transition:all 0.3s;background:transparent}
.form-check.selected{border-color:var(--cyan);color:var(--cyan);background:rgba(42,157,143,0.08)}
.btn{padding:12px 24px;border-radius:12px;border:none;font-size:14px;font-weight:600;font-family:var(--font);cursor:pointer;transition:all 0.3s ease;display:flex;align-items:center;justify-content:center;gap:6px}
.btn:active{transform:scale(0.96)}
.btn-primary{background:linear-gradient(135deg,var(--cyan),#1a7a6f);color:#fff;width:100%}
.btn-outline{background:transparent;border:1px solid var(--cyan);color:var(--cyan)}
.btn-small{padding:6px 14px;font-size:12px;border-radius:8px}

/* Tab 2 - AI Analysis */
.life-clock-wrap{display:flex;flex-direction:column;align-items:center;padding:20px 0 10px}
.life-clock-ring{position:relative;width:180px;height:180px}
.life-clock-ring canvas{position:absolute;top:0;left:0}
.life-clock-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
.life-clock-years{font-family:var(--mono);font-size:42px;font-weight:800;background:linear-gradient(135deg,var(--cyan),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:1px;line-height:1}
.life-clock-label{font-size:11px;color:var(--text2);margin-top:2px}
.life-expect{font-size:13px;color:var(--text2);margin-top:8px}

.health-score-wrap{display:flex;align-items:center;gap:16px;padding:16px}
.score-ring{position:relative;width:90px;height:90px;flex-shrink:0}
.score-ring canvas{position:absolute;top:0;left:0}
.score-ring-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
.score-ring-value{font-family:var(--mono);font-size:28px;font-weight:800;letter-spacing:1px;line-height:1}
.score-ring-label{font-size:9px;color:var(--text2)}
.score-bars{flex:1;display:flex;flex-direction:column;gap:6px}
.score-bar-item{display:flex;align-items:center;gap:8px}
.score-bar-name{font-size:11px;color:var(--text2);width:68px;flex-shrink:0;text-align:right}
.score-bar-track{flex:1;height:6px;background:rgba(120,90,60,0.08);border-radius:3px;overflow:hidden}
.score-bar-fill{height:100%;border-radius:3px;transition:width 1s ease}
.score-bar-val{font-size:10px;color:var(--text2);width:22px;font-family:var(--mono)}

.gen-report-btn{margin:12px 0}
.analyzing-wrap{text-align:center;padding:30px 0}
.analyzing-spinner{width:50px;height:50px;border:3px solid var(--glass-border);border-top-color:var(--cyan);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 16px}
@keyframes spin{to{transform:rotate(360deg)}}
.analyzing-stage{font-size:14px;color:var(--text2)}
.report-section{margin-top:16px}
.report-section .rs-title{font-size:15px;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:6px;color:var(--text)}
.report-narrative{font-size:13px;color:var(--text2);line-height:1.7;margin-bottom:10px}
.range-indicator{margin:8px 0;position:relative}
.range-bar{height:8px;border-radius:4px;background:linear-gradient(90deg,var(--green),var(--gold),var(--coral));position:relative}
.range-marker{position:absolute;top:-4px;width:3px;height:16px;background:var(--text);border-radius:1px;transform:translateX(-50%)}
.range-labels{display:flex;justify-content:space-between;font-size:9px;color:var(--text3);margin-top:3px}
.risk-card{padding:12px;margin-bottom:8px;border-left:3px solid;position:relative}
.risk-card.risk-high{border-left-color:var(--coral);background:rgba(231,111,81,0.06)}
.risk-card.risk-medium{border-left-color:var(--orange);background:rgba(224,122,58,0.06)}
.risk-card.risk-watch{border-left-color:var(--gold);background:rgba(233,168,32,0.06)}
.risk-card.risk-normal{border-left-color:var(--green);background:rgba(64,145,108,0.06)}
.risk-card .risk-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.risk-card .risk-name{font-size:14px;font-weight:600}
.risk-card .risk-badge{font-size:10px;padding:2px 8px;border-radius:10px;font-weight:600}
.risk-high .risk-badge{background:rgba(231,111,81,0.15);color:var(--coral)}
.risk-medium .risk-badge{background:rgba(224,122,58,0.15);color:var(--orange)}
.risk-watch .risk-badge{background:rgba(233,168,32,0.15);color:var(--gold)}
.risk-normal .risk-badge{background:rgba(64,145,108,0.15);color:var(--green)}
.risk-card .risk-desc{font-size:12px;color:var(--text2);line-height:1.6;margin-bottom:4px}
.risk-card .risk-systems{font-size:10px;color:var(--text3)}
.risk-card .risk-action{font-size:11px;color:var(--cyan);margin-top:4px}
.rec-card{padding:14px;margin-bottom:10px;border:1px solid var(--glass-border);position:relative}
.rec-card .rec-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.rec-card .rec-icon{font-size:20px}
.rec-card .rec-title{font-size:14px;font-weight:600;flex:1}
.rec-card .rec-priority{font-size:10px;padding:2px 8px;border-radius:10px}
.rec-priority.urgent{background:rgba(231,111,81,0.15);color:var(--coral)}
.rec-priority.important{background:rgba(233,168,32,0.15);color:var(--gold)}
.rec-priority.recommended{background:rgba(64,145,108,0.15);color:var(--green)}
.rec-card .rec-desc{font-size:12px;color:var(--text2);line-height:1.6;margin-bottom:6px}
.rec-card .rec-target{font-size:11px;color:var(--cyan);margin-bottom:3px}
.rec-card .rec-timeline{font-size:11px;color:var(--text3)}
.rec-card .rec-benefit{font-size:11px;color:var(--green);margin-top:3px}
.waterfall-item{display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid var(--glass-border)}
.waterfall-item:last-child{border-bottom:none}
.wf-label{font-size:12px;color:var(--text2);width:100px;flex-shrink:0}
.wf-bar-wrap{flex:1;display:flex;align-items:center;justify-content:center;position:relative;height:18px}
.wf-bar{height:12px;border-radius:6px;min-width:4px}
.wf-bar.positive{background:var(--green)}
.wf-bar.negative{background:var(--coral)}
.wf-value{font-size:11px;font-family:var(--mono);width:45px;text-align:right;flex-shrink:0}
.wf-value.positive{color:var(--green)}
.wf-value.negative{color:var(--coral)}
.chart-container{position:relative;height:200px;margin:12px 0}
.monitor-card{display:flex;align-items:center;gap:10px;padding:10px;margin-bottom:8px}
.monitor-card .mon-icon{font-size:18px;width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:rgba(120,90,60,0.04)}
.monitor-card .mon-info{flex:1}
.monitor-card .mon-name{font-size:13px;font-weight:500}
.monitor-card .mon-freq{font-size:11px;color:var(--text2)}

/* Tab 3 */
.countdown-wrap{text-align:center;padding:16px 0}
.date-display{font-size:14px;color:var(--text2);margin-bottom:8px}
.countdown-time{font-family:var(--mono);font-size:48px;font-weight:800;letter-spacing:2px;background:linear-gradient(135deg,var(--cyan),var(--green));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.day-progress-wrap{display:flex;align-items:center;justify-content:center;gap:10px;margin-top:10px}
.day-ring{width:44px;height:44px;position:relative}
.day-ring canvas{position:absolute;top:0;left:0}
.day-ring-pct{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:10px;font-family:var(--mono);color:var(--text2)}
.day-progress-label{font-size:12px;color:var(--text2)}
.quick-add-bar{display:flex;gap:8px;margin:12px 0}
.quick-add-input{flex:1;padding:10px 14px;background:rgba(120,90,60,0.04);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:var(--font);outline:none}
.quick-add-input:focus{border-color:var(--cyan)}
.priority-sel{display:flex;border:1px solid var(--glass-border);border-radius:10px;overflow:hidden}
.priority-opt{padding:8px 10px;font-size:11px;cursor:pointer;border:none;background:transparent;color:var(--text3);font-family:var(--font);transition:all 0.3s}
.priority-opt.active{color:#fff}
.priority-opt.p-high.active{background:var(--coral);color:#fff}
.priority-opt.p-med.active{background:var(--gold);color:#fff}
.priority-opt.p-low.active{background:var(--green);color:#fff}
.add-btn{width:42px;height:42px;border-radius:12px;border:none;background:var(--cyan);color:#fff;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s}
.add-btn:active{transform:scale(0.92)}
.stats-bar{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin:12px 0}
.stat-card{text-align:center;padding:10px;background:var(--card);border:1px solid var(--glass-border);border-radius:10px;box-shadow:0 1px 4px rgba(120,90,60,0.05)}
.stat-num{font-family:var(--mono);font-size:22px;font-weight:700;letter-spacing:1px}
.stat-label{font-size:10px;color:var(--text2);margin-top:2px}
.task-group{margin-bottom:12px}
.task-group-title{font-size:12px;font-weight:600;padding:6px 10px;border-radius:8px 8px 0 0;display:flex;align-items:center;gap:4px}
.task-group-title.tg-high{background:rgba(231,111,81,0.1);color:var(--coral)}
.task-group-title.tg-med{background:rgba(233,168,32,0.1);color:var(--gold)}
.task-group-title.tg-low{background:rgba(64,145,108,0.1);color:var(--green)}
.task-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid var(--glass-border);background:var(--card);transition:all 0.3s}
.task-item:last-child{border-bottom:none;border-radius:0 0 8px 8px}
.task-check{width:20px;height:20px;border-radius:50%;border:2px solid var(--text3);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s;flex-shrink:0;background:transparent}
.task-check.checked{border-color:var(--green);background:var(--green)}
.task-check.checked::after{content:'âœ“';font-size:11px;color:#fff}
.task-text{flex:1;font-size:13px;transition:all 0.3s}
.task-text.done{text-decoration:line-through;color:var(--text3)}
.task-priority{font-size:9px;padding:2px 6px;border-radius:8px;flex-shrink:0}
.tp-high{background:rgba(231,111,81,0.15);color:var(--coral)}
.tp-med{background:rgba(233,168,32,0.15);color:var(--gold)}
.tp-low{background:rgba(64,145,108,0.15);color:var(--green)}
.task-time{font-size:10px;color:var(--text3);font-family:var(--mono);flex-shrink:0}
.task-del{width:24px;height:24px;border-radius:6px;border:none;background:rgba(231,111,81,0.1);color:var(--coral);font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.3s;opacity:0.6}
.task-del:active{opacity:1;transform:scale(0.9)}
.completed-section{opacity:0.6}

/* Tab 4 */
.remain-banner{text-align:center;padding:16px 0}
.remain-years{font-family:var(--mono);font-size:52px;font-weight:800;letter-spacing:2px;background:linear-gradient(135deg,var(--gold),var(--orange));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1.1}
.remain-label{font-size:14px;color:var(--text2);margin-top:4px}
.goal-progress-wrap{display:flex;align-items:center;gap:14px;padding:14px}
.goal-ring{position:relative;width:60px;height:60px;flex-shrink:0}
.goal-ring canvas{position:absolute;top:0;left:0}
.goal-ring-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:14px;font-family:var(--mono);font-weight:700;color:var(--text)}
.goal-progress-text{font-size:13px;color:var(--text2)}
.cat-filter{display:flex;gap:8px;overflow-x:auto;padding:8px 0;scrollbar-width:none;-ms-overflow-style:none}
.cat-filter::-webkit-scrollbar{display:none}
.cat-chip{padding:6px 14px;border-radius:20px;border:1px solid var(--glass-border);font-size:12px;color:var(--text2);cursor:pointer;white-space:nowrap;transition:all 0.3s;flex-shrink:0;background:transparent;font-family:var(--font)}
.cat-chip.active{border-color:var(--cyan);color:var(--cyan);background:rgba(42,157,143,0.08)}
.life-timeline{position:relative;height:50px;margin:14px 0;background:var(--card);border-radius:10px;border:1px solid var(--glass-border);overflow:visible;padding:0 10px}
.timeline-bar{position:absolute;top:50%;left:10px;right:10px;height:4px;background:rgba(120,90,60,0.08);border-radius:2px;transform:translateY(-50%)}
.timeline-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--cyan),var(--purple))}
.timeline-marker{position:absolute;top:50%;width:10px;height:10px;border-radius:50%;transform:translate(-50%,-50%);cursor:pointer;z-index:2;transition:all 0.3s}
.timeline-marker:hover{transform:translate(-50%,-50%) scale(1.3)}
.timeline-marker .tm-label{position:absolute;bottom:14px;left:50%;transform:translateX(-50%);font-size:8px;white-space:nowrap;color:var(--text2);pointer-events:none}
.goal-card{padding:14px;margin-bottom:10px;position:relative}
.goal-card .goal-header{display:flex;align-items:center;gap:10px;margin-bottom:6px}
.goal-card .goal-emoji{font-size:24px}
.goal-card .goal-title{font-size:14px;font-weight:600;flex:1}
.goal-card .goal-cat{font-size:10px;padding:2px 8px;border-radius:10px;background:rgba(42,157,143,0.08);color:var(--cyan)}
.goal-card .goal-desc{font-size:12px;color:var(--text2);line-height:1.5;margin-bottom:6px}
.goal-card .goal-footer{display:flex;align-items:center;justify-content:space-between}
.goal-card .goal-age{font-size:11px;color:var(--text3)}
.goal-card .goal-status{font-size:10px;padding:3px 10px;border-radius:10px;cursor:pointer;border:none;font-family:var(--font);transition:all 0.3s}
.status-pending{background:rgba(58,48,40,0.06);color:var(--text2)}
.status-progress{background:rgba(42,157,143,0.12);color:var(--cyan)}
.status-done{background:rgba(64,145,108,0.12);color:var(--green)}
.goal-card .goal-del{position:absolute;top:10px;right:10px;width:22px;height:22px;border-radius:6px;border:none;background:rgba(231,111,81,0.1);color:var(--coral);font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.3s}
.goal-card:hover .goal-del,.goal-card:active .goal-del{opacity:1}
.preset-chips{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
.preset-chip{padding:6px 12px;border-radius:20px;border:1px solid var(--glass-border);font-size:12px;color:var(--text2);cursor:pointer;transition:all 0.3s;background:transparent;font-family:var(--font)}
.preset-chip:active{border-color:var(--cyan);color:var(--cyan);transform:scale(0.95)}

/* Animations */
@keyframes fadeInUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.fade-in-up{animation:fadeInUp 0.4s ease forwards}
.hidden{display:none!important}

/* ====== AUTH SCREEN ====== */
#authScreen{position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg);z-index:200;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity 0.4s ease,transform 0.4s ease}
#authScreen.auth-hidden{opacity:0;pointer-events:none;transform:translateY(-20px)}
.auth-container{width:100%;max-width:380px;padding:0 24px}
.auth-logo{text-align:center;margin-bottom:32px}
.auth-logo-icon{font-size:48px;margin-bottom:8px}
.auth-logo-text{font-size:28px;font-weight:700;background:linear-gradient(135deg,var(--cyan),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:3px}
.auth-logo-sub{font-size:13px;color:var(--text2);margin-top:4px}
.auth-card{background:var(--card);border:1px solid var(--glass-border);border-radius:16px;padding:24px 20px;box-shadow:0 4px 20px rgba(120,90,60,0.08)}
.auth-title{font-size:18px;font-weight:600;text-align:center;margin-bottom:20px;color:var(--text)}
.auth-input-group{margin-bottom:14px;position:relative}
.auth-input-label{font-size:12px;color:var(--text2);margin-bottom:5px;display:block}
.auth-input{width:100%;padding:12px 14px;background:rgba(120,90,60,0.04);border:1px solid var(--glass-border);border-radius:10px;color:var(--text);font-size:15px;font-family:var(--font);outline:none;transition:border-color 0.3s}
.auth-input:focus{border-color:var(--cyan)}
.auth-input::placeholder{color:var(--text3)}
.auth-phone-row{display:flex;gap:8px}
.auth-phone-prefix{width:60px;padding:12px 8px;background:rgba(120,90,60,0.04);border:1px solid var(--glass-border);border-radius:10px;color:var(--text2);font-size:14px;text-align:center;flex-shrink:0;line-height:1.2}
.auth-phone-input{flex:1}
.auth-sms-row{display:flex;gap:8px}
.auth-sms-input{flex:1}
.auth-sms-btn{min-width:100px;padding:12px 8px;border-radius:10px;border:1px solid var(--cyan);background:transparent;color:var(--cyan);font-size:13px;font-family:var(--font);cursor:pointer;transition:all 0.3s;white-space:nowrap}
.auth-sms-btn:active{transform:scale(0.96)}
.auth-sms-btn:disabled{border-color:var(--text3);color:var(--text3);cursor:not-allowed}
.auth-pwd-wrap{position:relative}
.auth-pwd-toggle{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;font-size:16px;cursor:pointer;color:var(--text3);padding:4px}
.auth-submit{width:100%;padding:13px;border-radius:12px;border:none;font-size:15px;font-weight:600;font-family:var(--font);background:linear-gradient(135deg,var(--cyan),#1a7a6f);color:#fff;cursor:pointer;transition:all 0.3s;margin-top:6px}
.auth-submit:active{transform:scale(0.97)}
.auth-submit:disabled{opacity:0.6;cursor:not-allowed}
.auth-links{display:flex;justify-content:space-between;margin-top:14px;font-size:13px}
.auth-link{color:var(--cyan);cursor:pointer;background:none;border:none;font-family:var(--font);font-size:13px;padding:0}
.auth-link:active{opacity:0.7}
.auth-error{color:var(--coral);font-size:12px;text-align:center;margin-top:8px;min-height:18px;transition:color 0.3s}
.auth-view{display:none}
.auth-view.active{display:block}
.auth-logout-btn{position:absolute;top:12px;right:16px;background:none;border:1px solid var(--glass-border);border-radius:8px;padding:4px 10px;font-size:11px;color:var(--text2);font-family:var(--font);cursor:pointer;z-index:11}
.auth-logout-btn:active{opacity:0.7}
.auth-user-info{position:absolute;top:12px;left:16px;font-size:11px;color:var(--text2);z-index:11;display:flex;align-items:center;gap:4px}
</style>
</head>
<body>

<!-- Auth Screen -->
<div id="authScreen">
  <div class="auth-container">
    <div class="auth-logo">
      <div class="auth-logo-icon">ğŸ§­</div>
      <div class="auth-logo-text">ç”Ÿå‘½å¯¼èˆª</div>
      <div class="auth-logo-sub">å¥åº·ä¸äººç”Ÿè§„åˆ’</div>
    </div>
    <div class="auth-card">
      <div class="auth-title">æ‰‹æœºå·ç™»å½•</div>
      <div class="auth-input-group">
        <label class="auth-input-label">æ‰‹æœºå·</label>
        <div class="auth-phone-row">
          <div class="auth-phone-prefix">+86</div>
          <input class="auth-input auth-phone-input" id="loginPhone" type="tel" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" maxlength="11" inputmode="numeric">
        </div>
      </div>
      <div class="auth-input-group">
        <label class="auth-input-label">éªŒè¯ç </label>
        <div class="auth-sms-row">
          <input class="auth-input auth-sms-input" id="loginCode" type="tel" placeholder="6ä½éªŒè¯ç " maxlength="6" inputmode="numeric">
          <button class="auth-sms-btn" id="loginSmsBtn" onclick="getLoginCode()">è·å–éªŒè¯ç </button>
        </div>
      </div>
      <div id="codeDisplay" style="text-align:center;margin:8px 0;font-size:13px;color:var(--text2);min-height:20px"></div>
      <button class="auth-submit" id="loginSubmitBtn" onclick="doLogin()">ç™»å½•</button>
      <div class="auth-error" id="loginError"></div>
    </div>
  </div>
</div>

<canvas id="starfield"></canvas>
<div id="app" style="display:none">
<header class="app-header"><div class="app-title">ç”Ÿå‘½å¯¼èˆª</div></header>
<div class="pages-container">
<!-- PAGE 1: Health Data -->
<div class="page active" id="page-health">
  <div class="section-title">ğŸ“± æ•°æ®æ¥æº</div>
  <div class="device-scroll" id="deviceScroll"></div>

  <div class="section-title">ğŸ“Š å¥åº·æŒ‡æ ‡</div>
  <div class="grid-2" id="metricsGrid"></div>

  <div style="margin-top:14px">
    <button class="btn btn-outline" onclick="openManualEntry()" style="width:100%">âœï¸ æ‰‹åŠ¨å½•å…¥å¥åº·æ•°æ®</button>
  </div>
</div>

<!-- PAGE 2: AI Analysis -->
<div class="page" id="page-ai">
  <div class="card life-clock-wrap">
    <div class="life-clock-ring">
      <canvas id="lifeClockCanvas" width="180" height="180"></canvas>
      <div class="life-clock-center">
        <div class="life-clock-years" id="lifeClockYears">--</div>
        <div class="life-clock-label">é¢„è®¡å‰©ä½™å¹´</div>
      </div>
    </div>
    <div class="life-expect" id="lifeExpectText">è¯·å…ˆå½•å…¥å¥åº·æ•°æ®</div>
  </div>

  <div class="card health-score-wrap" style="margin-top:10px">
    <div class="score-ring">
      <canvas id="scoreRingCanvas" width="90" height="90"></canvas>
      <div class="score-ring-center">
        <div class="score-ring-value" id="scoreValue">--</div>
        <div class="score-ring-label">å¥åº·åˆ†</div>
      </div>
    </div>
    <div class="score-bars" id="scoreBars"></div>
  </div>

  <button class="btn btn-primary gen-report-btn" id="genReportBtn" onclick="generateReport()">ğŸ”¬ ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š</button>

  <div id="analyzingWrap" class="analyzing-wrap hidden">
    <div class="analyzing-spinner"></div>
    <div class="analyzing-stage" id="analyzingStage">é‡‡é›†æ•°æ®...</div>
  </div>

  <div id="reportContainer" class="hidden"></div>
</div>

<!-- PAGE 3: Time Management -->
<div class="page" id="page-time">
  <div class="card countdown-wrap">
    <div class="date-display" id="dateDisplay"></div>
    <div class="countdown-time" id="countdownTime">--:--:--</div>
    <div class="day-progress-wrap">
      <div class="day-ring">
        <canvas id="dayRingCanvas" width="44" height="44"></canvas>
        <div class="day-ring-pct" id="dayPct">0%</div>
      </div>
      <div class="day-progress-label">ä»Šæ—¥å·²è¿‡</div>
    </div>
  </div>

  <div class="quick-add-bar">
    <input class="quick-add-input" id="taskInput" placeholder="æ·»åŠ æ–°ä»»åŠ¡..." maxlength="100">
    <div class="priority-sel">
      <button class="priority-opt p-high active" data-p="high" onclick="selectPriority('high')">é«˜</button>
      <button class="priority-opt p-med" data-p="med" onclick="selectPriority('med')">ä¸­</button>
      <button class="priority-opt p-low" data-p="low" onclick="selectPriority('low')">ä½</button>
    </div>
    <button class="add-btn" onclick="addTask()">+</button>
  </div>

  <div class="stats-bar" id="taskStats"></div>
  <div id="taskList"></div>
</div>

<!-- PAGE 4: Life Planning -->
<div class="page" id="page-life">
  <div class="card remain-banner">
    <div style="font-size:13px;color:var(--text2);margin-bottom:4px">é¢„è®¡å‰©ä½™</div>
    <div class="remain-years" id="remainYears">--</div>
    <div class="remain-label">å¹´çš„ç²¾å½©äººç”Ÿ</div>
  </div>

  <div class="card goal-progress-wrap" style="margin-top:10px">
    <div class="goal-ring">
      <canvas id="goalRingCanvas" width="60" height="60"></canvas>
      <div class="goal-ring-center" id="goalRingText">0/0</div>
    </div>
    <div class="goal-progress-text" id="goalProgressText">å°šæœªè®¾å®šäººç”Ÿç›®æ ‡</div>
  </div>

  <div class="cat-filter" id="catFilter"></div>
  <div class="card life-timeline" id="lifeTimeline"><div class="timeline-bar"><div class="timeline-fill" id="timelineFill"></div></div></div>

  <div class="section-title">ğŸ¯ æˆ‘çš„äººç”Ÿç›®æ ‡</div>
  <div id="goalList"></div>

  <button class="btn btn-primary" onclick="openGoalModal()" style="margin-top:12px">+ æ·»åŠ æ–°ç›®æ ‡</button>

  <div class="section-title">âš¡ å¿«é€Ÿæ·»åŠ </div>
  <div class="preset-chips" id="presetChips"></div>
</div>
</div>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
  <div class="nav-item active" onclick="switchTab(0)" data-tab="0">
    <span class="nav-icon">â¤ï¸</span><span class="nav-label">å¥åº·æ•°æ®</span>
  </div>
  <div class="nav-item" onclick="switchTab(1)" data-tab="1">
    <span class="nav-icon">ğŸ§ </span><span class="nav-label">AI åˆ†æ</span>
  </div>
  <div class="nav-item" onclick="switchTab(2)" data-tab="2">
    <span class="nav-icon">â°</span><span class="nav-label">æ—¶é—´ç®¡ç†</span>
  </div>
  <div class="nav-item" onclick="switchTab(3)" data-tab="3">
    <span class="nav-icon">ğŸŒŸ</span><span class="nav-label">äººç”Ÿè§„åˆ’</span>
  </div>
</nav>

<!-- Manual Entry Modal -->
<div class="modal-overlay" id="manualModal">
<div class="modal-sheet">
  <div class="modal-handle"></div>
  <div class="modal-title">æ‰‹åŠ¨å½•å…¥å¥åº·æ•°æ®</div>
  <div class="form-row">
    <div class="form-group"><label class="form-label">å¹´é¾„</label><input class="form-input" id="f-age" type="number" placeholder="25"></div>
    <div class="form-group"><label class="form-label">æ€§åˆ«</label><select class="form-input form-select" id="f-gender"><option value="">è¯·é€‰æ‹©</option><option value="male">ç”·</option><option value="female">å¥³</option></select></div>
  </div>
  <div class="form-row">
    <div class="form-group"><label class="form-label">èº«é«˜ (cm)</label><input class="form-input" id="f-height" type="number" placeholder="170"></div>
    <div class="form-group"><label class="form-label">ä½“é‡ (kg)</label><input class="form-input" id="f-weight" type="number" placeholder="65" step="0.1"></div>
  </div>
  <div class="form-row">
    <div class="form-group"><label class="form-label">æ­¥æ•°</label><input class="form-input" id="f-steps" type="number" placeholder="8000"></div>
    <div class="form-group"><label class="form-label">å¿ƒç‡ (bpm)</label><input class="form-input" id="f-heartrate" type="number" placeholder="72"></div>
  </div>
  <div class="form-row">
    <div class="form-group"><label class="form-label">æ”¶ç¼©å‹ (mmHg)</label><input class="form-input" id="f-systolic" type="number" placeholder="120"></div>
    <div class="form-group"><label class="form-label">èˆ’å¼ å‹ (mmHg)</label><input class="form-input" id="f-diastolic" type="number" placeholder="80"></div>
  </div>
  <div class="form-row">
    <div class="form-group"><label class="form-label">è¡€ç³– (mmol/L)</label><input class="form-input" id="f-glucose" type="number" placeholder="5.2" step="0.1"></div>
    <div class="form-group"><label class="form-label">è¡€æ°§ (%)</label><input class="form-input" id="f-oxygen" type="number" placeholder="98"></div>
  </div>
  <div class="form-row">
    <div class="form-group"><label class="form-label">ä½“æ¸© (Â°C)</label><input class="form-input" id="f-temp" type="number" placeholder="36.5" step="0.1"></div>
    <div class="form-group"><label class="form-label">ç¡çœ  (å°æ—¶)</label><input class="form-input" id="f-sleep" type="number" placeholder="7.5" step="0.1"></div>
  </div>
  <div class="form-group"><label class="form-label">æ¯å‘¨è¿åŠ¨ (åˆ†é’Ÿ)</label><input class="form-input" id="f-exercise" type="number" placeholder="150"></div>
  <div class="form-group">
    <label class="form-label">æ˜¯å¦å¸çƒŸ</label>
    <div class="form-check-group" id="f-smoking">
      <button class="form-check" data-val="never">ä»ä¸</button>
      <button class="form-check" data-val="quit">å·²æˆ’çƒŸ</button>
      <button class="form-check" data-val="occasional">å¶å°”</button>
      <button class="form-check" data-val="frequent">ç»å¸¸</button>
    </div>
  </div>
  <div class="form-group">
    <label class="form-label">é¥®é…’é¢‘ç‡</label>
    <div class="form-check-group" id="f-alcohol">
      <button class="form-check" data-val="never">ä»ä¸</button>
      <button class="form-check" data-val="occasional">å¶å°”</button>
      <button class="form-check" data-val="frequent">ç»å¸¸</button>
    </div>
  </div>
  <div class="form-group">
    <label class="form-label">å®¶æ—ç—…å² (å¯å¤šé€‰)</label>
    <div class="form-check-group" id="f-family">
      <button class="form-check" data-val="hypertension">é«˜è¡€å‹</button>
      <button class="form-check" data-val="diabetes">ç³–å°¿ç—…</button>
      <button class="form-check" data-val="heart">å¿ƒè„ç—…</button>
      <button class="form-check" data-val="cancer">ç™Œç—‡</button>
      <button class="form-check" data-val="none">æ— </button>
    </div>
  </div>
  <button class="btn btn-primary" onclick="saveManualEntry()" style="margin-top:8px">ä¿å­˜æ•°æ®</button>
  <button class="btn btn-outline" onclick="closeManualEntry()" style="margin-top:8px;width:100%">å–æ¶ˆ</button>
</div>
</div>

<!-- Goal Modal -->
<div class="modal-overlay" id="goalModal">
<div class="modal-sheet">
  <div class="modal-handle"></div>
  <div class="modal-title">æ·»åŠ äººç”Ÿç›®æ ‡</div>
  <div class="form-group"><label class="form-label">ç›®æ ‡åç§°</label><input class="form-input" id="g-title" placeholder="ä¾‹å¦‚ï¼šç¯æ¸¸ä¸–ç•Œ" maxlength="50"></div>
  <div class="form-group"><label class="form-label">ç±»åˆ«</label><select class="form-input form-select" id="g-cat">
    <option value="æ—…è¡Œ">ğŸŒ æ—…è¡Œ</option><option value="å­¦ä¹ ">ğŸ“š å­¦ä¹ </option><option value="äº‹ä¸š">ğŸ’¼ äº‹ä¸š</option><option value="å®¶åº­">ğŸ  å®¶åº­</option><option value="å¥åº·">ğŸ’ª å¥åº·</option><option value="å†’é™©">ğŸ” å†’é™©</option><option value="åˆ›é€ ">ğŸ¨ åˆ›é€ </option><option value="ç¤¾äº¤">ğŸ¤ ç¤¾äº¤</option>
  </select></div>
  <div class="form-group"><label class="form-label">ç›®æ ‡å¹´é¾„</label><input class="form-input" id="g-age" type="number" placeholder="35"></div>
  <div class="form-group"><label class="form-label">æè¿°</label><input class="form-input" id="g-desc" placeholder="ç®€è¦æè¿°è¿™ä¸ªç›®æ ‡..." maxlength="200"></div>
  <button class="btn btn-primary" onclick="saveGoal()" style="margin-top:8px">æ·»åŠ ç›®æ ‡</button>
  <button class="btn btn-outline" onclick="closeGoalModal()" style="margin-top:8px;width:100%">å–æ¶ˆ</button>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script>
// ============================================================
// AUTH SYSTEM (Local verification code - no backend required)
// ============================================================
const LS_AUTH_USER = 'ln_auth_user';
let _currentCode = '';
let _currentCodePhone = '';

function getAuthUser() { try { return JSON.parse(localStorage.getItem(LS_AUTH_USER)); } catch(e) { return null; } }
function saveAuthUser(phone) {
  const masked = phone.substring(0,3) + '****' + phone.substring(7);
  localStorage.setItem(LS_AUTH_USER, JSON.stringify({ phone: masked, fullPhone: phone, loginTime: Date.now() }));
}
function clearAuth() { localStorage.removeItem(LS_AUTH_USER); }
function isValidPhone(phone) { return /^1[3-9]\d{9}$/.test(phone); }
function showAuthError(msg) { document.getElementById('loginError').textContent = msg; }

function checkAuth() {
  const user = getAuthUser();
  if (user && user.phone) {
    hideAuthScreen();
  } else {
    showAuthScreen();
  }
}

function showAuthScreen() {
  document.getElementById('authScreen').classList.remove('auth-hidden');
  document.getElementById('app').style.display = 'none';
}

function hideAuthScreen() {
  document.getElementById('authScreen').classList.add('auth-hidden');
  document.getElementById('app').style.display = '';
  updateAuthUI();
  if (!window._appInitialized) {
    window._appInitialized = true;
    setTimeout(() => { if(typeof init === 'function') init(); }, 100);
  }
}

function updateAuthUI() {
  const user = getAuthUser();
  const header = document.querySelector('.app-header');
  if (!header) return;
  const existing = header.querySelectorAll('.auth-logout-btn,.auth-user-info');
  existing.forEach(e => e.remove());
  if (user && user.phone) {
    const info = document.createElement('span');
    info.className = 'auth-user-info';
    info.textContent = user.phone;
    header.appendChild(info);
    const btn = document.createElement('button');
    btn.className = 'auth-logout-btn';
    btn.textContent = 'é€€å‡º';
    btn.onclick = doLogout;
    header.appendChild(btn);
  }
}

function getLoginCode() {
  const phone = document.getElementById('loginPhone').value.trim();
  if (!isValidPhone(phone)) { showAuthError('è¯·è¾“å…¥æ­£ç¡®çš„11ä½æ‰‹æœºå·'); return; }

  // Generate random 6-digit code
  _currentCode = String(Math.floor(100000 + Math.random() * 900000));
  _currentCodePhone = phone;

  // Display the code to the user
  document.getElementById('codeDisplay').innerHTML = 'æ‚¨çš„éªŒè¯ç ï¼š<b style="color:var(--cyan);font-size:20px;letter-spacing:4px">' + _currentCode + '</b>';
  showAuthError('');

  // Start 60s cooldown on button
  const btn = document.getElementById('loginSmsBtn');
  btn.disabled = true;
  let sec = 60;
  btn.textContent = sec + 'ç§’';
  const timer = setInterval(() => {
    sec--;
    btn.textContent = sec + 'ç§’';
    if (sec <= 0) {
      clearInterval(timer);
      btn.textContent = 'è·å–éªŒè¯ç ';
      btn.disabled = false;
      _currentCode = '';
      _currentCodePhone = '';
      document.getElementById('codeDisplay').textContent = '';
    }
  }, 1000);
}

function doLogin() {
  const phone = document.getElementById('loginPhone').value.trim();
  const code = document.getElementById('loginCode').value.trim();
  if (!isValidPhone(phone)) { showAuthError('è¯·è¾“å…¥æ­£ç¡®çš„11ä½æ‰‹æœºå·'); return; }
  if (!code || code.length !== 6) { showAuthError('è¯·è¾“å…¥6ä½éªŒè¯ç '); return; }
  if (!_currentCode || !_currentCodePhone) { showAuthError('è¯·å…ˆè·å–éªŒè¯ç '); return; }
  if (phone !== _currentCodePhone) { showAuthError('æ‰‹æœºå·ä¸è·å–éªŒè¯ç æ—¶ä¸ä¸€è‡´'); return; }
  if (code !== _currentCode) { showAuthError('éªŒè¯ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥'); return; }

  // Verification passed
  saveAuthUser(phone);
  _currentCode = '';
  _currentCodePhone = '';
  document.getElementById('loginCode').value = '';
  document.getElementById('codeDisplay').textContent = '';
  hideAuthScreen();
}

function doLogout() {
  clearAuth();
  window._appInitialized = false;
  document.getElementById('loginPhone').value = '';
  document.getElementById('loginCode').value = '';
  document.getElementById('codeDisplay').textContent = '';
  showAuthError('');
  showAuthScreen();
}

// ============================================================
// CAPACITOR / HEALTH CONNECT BRIDGE
// ============================================================
const isCapacitor = typeof window.Capacitor !== 'undefined';
let HealthConnectBridge = null;

// Register Capacitor plugin bridge
if (isCapacitor && window.Capacitor.Plugins) {
  HealthConnectBridge = window.Capacitor.Plugins.HealthConnect || null;
}
// Also try registering via Capacitor.registerPlugin for newer versions
if (!HealthConnectBridge && isCapacitor && window.Capacitor.registerPlugin) {
  try {
    HealthConnectBridge = window.Capacitor.registerPlugin('HealthConnect');
  } catch(e) { console.log('Health Connect plugin not available:', e); }
}

// Health Connect availability state
let healthConnectAvailable = false;
let healthConnectStatus = 'unknown'; // 'available', 'unavailable', 'update_required'

async function checkHealthConnectAvailability() {
  if (!HealthConnectBridge) {
    healthConnectStatus = 'not_native';
    return false;
  }
  try {
    const result = await HealthConnectBridge.checkAvailability();
    healthConnectAvailable = result.available;
    healthConnectStatus = result.status;
    return result.available;
  } catch(e) {
    console.log('Health Connect check failed:', e);
    healthConnectStatus = 'error';
    return false;
  }
}

async function requestHealthConnectPermissions() {
  if (!HealthConnectBridge) return false;
  try {
    const result = await HealthConnectBridge.requestHealthPermissions();
    return result.granted || result.requested;
  } catch(e) {
    console.log('Permission request failed:', e);
    return false;
  }
}

async function readHealthConnectData() {
  if (!HealthConnectBridge) return null;
  try {
    const result = await HealthConnectBridge.readHealthData();
    if (result.success) return result;
    return null;
  } catch(e) {
    console.log('Health data read failed:', e);
    return null;
  }
}

async function openHealthConnectSettings() {
  if (!HealthConnectBridge) return;
  try {
    await HealthConnectBridge.openHealthConnectApp();
  } catch(e) {
    console.log('Could not open Health Connect:', e);
  }
}

// Initialize Health Connect check on app start
if (isCapacitor) {
  document.addEventListener('DOMContentLoaded', () => {
    checkHealthConnectAvailability().then(() => {
      console.log('Health Connect status:', healthConnectStatus);
    });
    checkHuaweiHealthAvailability().then(() => {
      console.log('Huawei Health status:', huaweiHealthStatus);
    });
    // Re-render once all checks done
    setTimeout(() => renderDevices(), 1500);
  });
}

// ============================================================
// HUAWEI HEALTH BRIDGE
// ============================================================
let HuaweiHealthBridge = null;
let huaweiHealthAvailable = false;
let huaweiHealthStatus = 'unknown';

if (isCapacitor && window.Capacitor.Plugins) {
  HuaweiHealthBridge = window.Capacitor.Plugins.HuaweiHealth || null;
}
if (!HuaweiHealthBridge && isCapacitor && window.Capacitor.registerPlugin) {
  try {
    HuaweiHealthBridge = window.Capacitor.registerPlugin('HuaweiHealth');
  } catch(e) { console.log('Huawei Health plugin not available:', e); }
}

async function checkHuaweiHealthAvailability() {
  if (!HuaweiHealthBridge) {
    huaweiHealthStatus = 'not_native';
    return false;
  }
  try {
    const result = await HuaweiHealthBridge.checkAvailability();
    huaweiHealthAvailable = result.available;
    huaweiHealthStatus = result.status;
    return result.available;
  } catch(e) {
    console.log('Huawei Health check failed:', e);
    huaweiHealthStatus = 'error';
    return false;
  }
}

async function huaweiSignIn() {
  if (!HuaweiHealthBridge) return false;
  try {
    const result = await HuaweiHealthBridge.signIn();
    return result.success;
  } catch(e) {
    console.log('Huawei sign in failed:', e);
    return false;
  }
}

async function huaweiRequestAuth() {
  if (!HuaweiHealthBridge) return false;
  try {
    const result = await HuaweiHealthBridge.requestHealthAuth();
    return result.success;
  } catch(e) {
    console.log('Huawei health auth failed:', e);
    return false;
  }
}

async function readHuaweiHealthData() {
  if (!HuaweiHealthBridge) return null;
  try {
    const result = await HuaweiHealthBridge.readHealthData();
    if (result.success) return result;
    return null;
  } catch(e) {
    console.log('Huawei health data read failed:', e);
    return null;
  }
}

// ============================================================
// DATA LAYER
// ============================================================
const LS_HEALTH = 'ln_health_data';
const LS_HEALTH_HISTORY = 'ln_health_history';
const LS_TASKS = 'ln_tasks_';
const LS_GOALS = 'ln_goals';
const LS_DEVICES = 'ln_devices';

function loadData(key, def) { try { const d = localStorage.getItem(key); return d ? JSON.parse(d) : def; } catch(e) { return def; } }
function saveData(key, data) { try { localStorage.setItem(key, JSON.stringify(data)); } catch(e) {} }

let healthData = loadData(LS_HEALTH, {});
let healthHistory = loadData(LS_HEALTH_HISTORY, {});
let devices = loadData(LS_DEVICES, {});
let goals = loadData(LS_GOALS, []);

function todayKey() { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function loadTasks() { return loadData(LS_TASKS + todayKey(), []); }
function saveTasks(t) { saveData(LS_TASKS + todayKey(), t); }

// ============================================================
// STARFIELD BACKGROUND
// ============================================================
(function initStarfield() {
  const c = document.getElementById('starfield');
  const ctx = c.getContext('2d');
  let dots = [];
  function resize() { c.width = window.innerWidth; c.height = window.innerHeight; dots = []; for(let i=0;i<60;i++) dots.push({x:Math.random()*c.width,y:Math.random()*c.height,r:Math.random()*1.5+0.5,speed:Math.random()*0.15+0.02,alpha:Math.random()*0.12+0.03}); }
  resize(); window.addEventListener('resize', resize);
  function draw() {
    ctx.clearRect(0,0,c.width,c.height);
    for(const s of dots) {
      s.y -= s.speed; if(s.y < -2) { s.y = c.height+2; s.x = Math.random()*c.width; }
      s.alpha += (Math.random()-0.5)*0.005; s.alpha = Math.max(0.02, Math.min(0.12, s.alpha));
      ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
      ctx.fillStyle = `rgba(180,150,120,${s.alpha})`; ctx.fill();
    }
    requestAnimationFrame(draw);
  }
  draw();
})();

// ============================================================
// TAB NAVIGATION
// ============================================================
let currentTab = 0;
const pages = ['page-health','page-ai','page-time','page-life'];
function switchTab(idx) {
  if(idx === currentTab) return;
  const navItems = document.querySelectorAll('.nav-item');
  navItems.forEach((n,i) => n.classList.toggle('active', i===idx));
  const prev = document.getElementById(pages[currentTab]);
  const next = document.getElementById(pages[idx]);
  prev.classList.remove('active');
  prev.classList.add('exit-left');
  setTimeout(() => prev.classList.remove('exit-left'), 350);
  next.classList.add('active');
  currentTab = idx;
  if(idx === 1) refreshAITab();
  if(idx === 2) refreshTimeTab();
  if(idx === 3) refreshLifeTab();
}

// ============================================================
// TAB 1: HEALTH DATA
// ============================================================
const deviceList = [
  { id:'healthconnect', name:'Health Connect', icon:'ğŸ’š', desc:'Google å¥åº·æ•°æ®å¹³å°' },
  { id:'apple', name:'Apple å¥åº·', icon:'ğŸ', desc:'éœ€è¦ iOS è®¾å¤‡' },
  { id:'huawei', name:'åä¸ºå¥åº·', icon:'ğŸ“±', desc:'åä¸º Health Kit' },
  { id:'xiaomi', name:'å°ç±³ç©¿æˆ´', icon:'âŒš', desc:'å³å°†æ”¯æŒ' },
  { id:'samsung', name:'Samsung Health', icon:'ğŸ’™', desc:'å³å°†æ”¯æŒ' },
  { id:'google', name:'Google Fit', icon:'ğŸƒ', desc:'å³å°†è¿ç§»è‡³ Health Connect' },
  { id:'manual', name:'æ‰‹åŠ¨å½•å…¥', icon:'âœï¸', desc:'ç›´æ¥è¾“å…¥å¥åº·æ•°æ®' }
];

const metrics = [
  { key:'steps', label:'æ­¥æ•°', unit:'æ­¥', icon:'ğŸ‘Ÿ', color:'var(--cyan)', range:[6000,10000] },
  { key:'heartrate', label:'å¿ƒç‡', unit:'bpm', icon:'â¤ï¸', color:'var(--coral)', range:[60,100] },
  { key:'glucose', label:'è¡€ç³–', unit:'mmol/L', icon:'ğŸ’§', color:'var(--gold)', range:[3.9,6.1] },
  { key:'systolic', label:'è¡€å‹', unit:'mmHg', icon:'ğŸ©º', color:'var(--purple)', range:[90,140], subkey:'diastolic', subunit:'/mmHg' },
  { key:'sleep', label:'ç¡çœ ', unit:'å°æ—¶', icon:'ğŸŒ™', color:'var(--lavender)', range:[7,9] },
  { key:'weight', label:'ä½“é‡', unit:'kg', icon:'âš–ï¸', color:'var(--green)', range:[50,80] },
  { key:'temp', label:'ä½“æ¸©', unit:'Â°C', icon:'ğŸŒ¡ï¸', color:'var(--orange)', range:[36.0,37.2] },
  { key:'oxygen', label:'è¡€æ°§', unit:'%', icon:'ğŸ«', color:'var(--blue)', range:[95,100] }
];

function renderDevices() {
  const wrap = document.getElementById('deviceScroll');
  wrap.innerHTML = deviceList.map(d => {
    const connected = devices[d.id];
    const cls = connected ? 'device-card connected' : 'device-card';
    let statusText = '';
    let btnText = '';
    let onclick = '';
    let disabled = false;

    if (d.id === 'manual') {
      statusText = '';
      btnText = 'å½•å…¥';
      onclick = 'openManualEntry()';
    } else if (d.id === 'healthconnect') {
      if (connected) {
        statusText = `<span style="color:var(--green)">â— å·²åŒæ­¥</span>`;
        btnText = 'é‡æ–°åŒæ­¥';
        onclick = `connectHealthConnect()`;
      } else if (isCapacitor && healthConnectAvailable) {
        statusText = `<span style="color:var(--cyan)">â— å¯ç”¨</span>`;
        btnText = 'è¿æ¥';
        onclick = `connectHealthConnect()`;
      } else if (isCapacitor && healthConnectStatus === 'update_required') {
        statusText = `<span style="color:var(--gold)">éœ€æ›´æ–°</span>`;
        btnText = 'å®‰è£…';
        onclick = `openHealthConnectSettings()`;
      } else if (!isCapacitor) {
        statusText = `<span style="color:var(--text2)">éœ€å®‰è£…APP</span>`;
        btnText = 'ä»…APK';
        disabled = true;
      } else {
        statusText = `<span style="color:var(--text2)">ä¸å¯ç”¨</span>`;
        btnText = 'å®‰è£…';
        onclick = `openHealthConnectSettings()`;
      }
    } else if (d.id === 'apple') {
      statusText = `<span style="color:var(--text2)">ä»…iOS</span>`;
      btnText = 'æš‚ä¸æ”¯æŒ';
      disabled = true;
    } else if (d.id === 'huawei') {
      if (connected) {
        statusText = `<span style="color:var(--green)">â— å·²åŒæ­¥</span>`;
        btnText = 'é‡æ–°åŒæ­¥';
        onclick = `connectHuaweiHealth()`;
      } else if (isCapacitor && huaweiHealthAvailable) {
        statusText = `<span style="color:var(--cyan)">â— å¯ç”¨</span>`;
        btnText = 'è¿æ¥';
        onclick = `connectHuaweiHealth()`;
      } else if (!isCapacitor) {
        statusText = `<span style="color:var(--text2)">éœ€å®‰è£…APP</span>`;
        btnText = 'ä»…APK';
        disabled = true;
      } else if (huaweiHealthStatus === 'not_native') {
        statusText = `<span style="color:var(--text2)">ä¸å¯ç”¨</span>`;
        btnText = 'ä»…åä¸ºè®¾å¤‡';
        disabled = true;
      } else {
        statusText = `<span style="color:var(--text2)">HMSä¸å¯ç”¨</span>`;
        btnText = 'ä¸å¯ç”¨';
        disabled = true;
      }
    } else if (['xiaomi','samsung','google'].includes(d.id)) {
      if (connected) {
        statusText = `<span style="color:var(--green)">â— å·²è¿æ¥</span>`;
        btnText = 'å·²åŒæ­¥';
      } else {
        statusText = `<span style="color:var(--text3)">å¼€å‘ä¸­</span>`;
        btnText = 'å³å°†ä¸Šçº¿';
        disabled = true;
      }
    } else {
      if (connected) {
        statusText = `<span style="color:var(--green)">â— å·²è¿æ¥</span>`;
        btnText = 'å·²åŒæ­¥';
      } else {
        btnText = 'è¿æ¥';
        onclick = `connectDevice('${d.id}')`;
      }
    }

    const disabledAttr = disabled ? 'disabled style="opacity:0.5;cursor:not-allowed"' : '';
    const descLine = d.desc ? `<div style="font-size:10px;color:var(--text3);margin-top:2px">${d.desc}</div>` : '';
    return `<div class="${cls}" id="dev-${d.id}"><div class="dev-icon">${d.icon}</div><div class="dev-name">${d.name}${descLine}</div><div class="dev-status">${statusText}</div><button class="sync-btn" onclick="${onclick}" ${disabledAttr}>${btnText}</button></div>`;
  }).join('');
}

// Health Connect native bridge connection
async function connectHealthConnect() {
  const card = document.getElementById('dev-healthconnect');
  if (!card) return;
  card.classList.add('connecting');
  const btn = card.querySelector('.sync-btn');
  const status = card.querySelector('.dev-status');
  btn.textContent = 'è¿æ¥ä¸­...';

  try {
    // Step 1: Check availability
    if (!healthConnectAvailable) {
      const avail = await checkHealthConnectAvailability();
      if (!avail) {
        status.innerHTML = `<span style="color:var(--coral)">ä¸å¯ç”¨</span>`;
        btn.textContent = 'å®‰è£…';
        btn.onclick = () => openHealthConnectSettings();
        card.classList.remove('connecting');
        return;
      }
    }

    // Step 2: Request permissions
    status.innerHTML = `<span style="color:var(--gold)">è¯·æ±‚æƒé™...</span>`;
    await requestHealthConnectPermissions();

    // Step 3: Read health data
    status.innerHTML = `<span style="color:var(--cyan)">è¯»å–æ•°æ®...</span>`;
    const data = await readHealthConnectData();

    if (data && data.success) {
      // Apply real health data
      const realData = {};
      if (data.steps !== undefined) realData.steps = data.steps;
      if (data.heartrate !== undefined) realData.heartrate = data.heartrate;
      if (data.glucose !== undefined) realData.glucose = data.glucose;
      if (data.systolic !== undefined) realData.systolic = data.systolic;
      if (data.diastolic !== undefined) realData.diastolic = data.diastolic;
      if (data.sleep !== undefined) realData.sleep = data.sleep;
      if (data.weight !== undefined) realData.weight = data.weight;
      if (data.temp !== undefined) realData.temp = data.temp;
      if (data.oxygen !== undefined) realData.oxygen = data.oxygen;

      Object.assign(healthData, realData);
      if (!healthData.age) healthData.age = 30;
      if (!healthData.gender) healthData.gender = 'male';
      if (!healthData.height) healthData.height = 170;
      if (!healthData.exercise) healthData.exercise = 120;
      if (!healthData.smoking) healthData.smoking = 'never';
      if (!healthData.alcohol) healthData.alcohol = 'occasional';
      if (!healthData.family) healthData.family = [];
      saveData(LS_HEALTH, healthData);
      addToHistory(realData);

      devices['healthconnect'] = { time: new Date().toISOString(), source: 'health_connect' };
      saveData(LS_DEVICES, devices);

      card.classList.remove('connecting');
      card.classList.add('connected');
      const count = Object.keys(realData).length;
      status.innerHTML = `<span style="color:var(--green)">â— å·²åŒæ­¥ ${count} é¡¹æ•°æ®</span>`;
      btn.textContent = 'é‡æ–°åŒæ­¥';
      renderMetrics();

      // Show success toast
      showToast(`å·²ä» Health Connect åŒæ­¥ ${count} é¡¹å¥åº·æ•°æ®`);
    } else {
      // No data available - might need permissions
      status.innerHTML = `<span style="color:var(--gold)">æ— æ•°æ®æˆ–éœ€æˆæƒ</span>`;
      btn.textContent = 'æˆæƒå¹¶é‡è¯•';
      card.classList.remove('connecting');
      showToast('æœªè·å–åˆ°æ•°æ®ï¼Œè¯·åœ¨ Health Connect ä¸­æˆæƒæœ¬åº”ç”¨');
    }
  } catch(e) {
    console.error('Health Connect error:', e);
    status.innerHTML = `<span style="color:var(--coral)">è¿æ¥å¤±è´¥</span>`;
    btn.textContent = 'é‡è¯•';
    card.classList.remove('connecting');
    showToast('Health Connect è¿æ¥å¤±è´¥: ' + (e.message || 'æœªçŸ¥é”™è¯¯'));
  }
}

// Huawei Health native bridge connection
async function connectHuaweiHealth() {
  const card = document.getElementById('dev-huawei');
  if (!card) return;
  card.classList.add('connecting');
  const btn = card.querySelector('.sync-btn');
  const status = card.querySelector('.dev-status');
  btn.textContent = 'è¿æ¥ä¸­...';

  try {
    // Step 1: Check availability
    if (!huaweiHealthAvailable) {
      await checkHuaweiHealthAvailability();
      if (!huaweiHealthAvailable) {
        status.innerHTML = `<span style="color:var(--coral)">HMSä¸å¯ç”¨</span>`;
        btn.textContent = 'ä¸å¯ç”¨';
        card.classList.remove('connecting');
        return;
      }
    }

    // Step 2: Sign in with Huawei ID
    status.innerHTML = `<span style="color:var(--gold)">åä¸ºè´¦å·ç™»å½•...</span>`;
    const signInResult = await huaweiSignIn();
    if (!signInResult) {
      status.innerHTML = `<span style="color:var(--coral)">ç™»å½•å¤±è´¥</span>`;
      btn.textContent = 'é‡è¯•';
      card.classList.remove('connecting');
      showToast('åä¸ºè´¦å·ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
      return;
    }

    // Step 3: Request health data authorization
    status.innerHTML = `<span style="color:var(--gold)">è¯·æ±‚å¥åº·æˆæƒ...</span>`;
    const authResult = await huaweiRequestAuth();
    if (!authResult) {
      status.innerHTML = `<span style="color:var(--coral)">æˆæƒå¤±è´¥</span>`;
      btn.textContent = 'é‡è¯•';
      card.classList.remove('connecting');
      showToast('å¥åº·æ•°æ®æˆæƒå¤±è´¥ï¼Œè¯·åœ¨å¼¹çª—ä¸­å…è®¸æˆæƒ');
      return;
    }

    // Step 4: Read health data
    status.innerHTML = `<span style="color:var(--cyan)">è¯»å–æ•°æ®...</span>`;
    const data = await readHuaweiHealthData();

    if (data && data.success) {
      const realData = {};
      if (data.steps !== undefined) realData.steps = data.steps;
      if (data.heartrate !== undefined) realData.heartrate = data.heartrate;
      if (data.glucose !== undefined) realData.glucose = data.glucose;
      if (data.systolic !== undefined) realData.systolic = data.systolic;
      if (data.diastolic !== undefined) realData.diastolic = data.diastolic;
      if (data.sleep !== undefined) realData.sleep = data.sleep;
      if (data.weight !== undefined) realData.weight = data.weight;
      if (data.temp !== undefined) realData.temp = data.temp;
      if (data.oxygen !== undefined) realData.oxygen = data.oxygen;

      Object.assign(healthData, realData);
      if (!healthData.age) healthData.age = 30;
      if (!healthData.gender) healthData.gender = 'male';
      if (!healthData.height) healthData.height = 170;
      if (!healthData.exercise) healthData.exercise = 120;
      if (!healthData.smoking) healthData.smoking = 'never';
      if (!healthData.alcohol) healthData.alcohol = 'occasional';
      if (!healthData.family) healthData.family = [];
      saveData(LS_HEALTH, healthData);
      addToHistory(realData);

      devices['huawei'] = { time: new Date().toISOString(), source: 'huawei_health' };
      saveData(LS_DEVICES, devices);

      card.classList.remove('connecting');
      card.classList.add('connected');
      const count = Object.keys(realData).length;
      status.innerHTML = `<span style="color:var(--green)">â— å·²åŒæ­¥ ${count} é¡¹æ•°æ®</span>`;
      btn.textContent = 'é‡æ–°åŒæ­¥';
      renderMetrics();
      showToast(`å·²ä»åä¸ºå¥åº·åŒæ­¥ ${count} é¡¹å¥åº·æ•°æ®`);
    } else {
      status.innerHTML = `<span style="color:var(--gold)">æ— æ•°æ®æˆ–éœ€æˆæƒ</span>`;
      btn.textContent = 'é‡è¯•';
      card.classList.remove('connecting');
      showToast('æœªè·å–åˆ°æ•°æ®ï¼Œè¯·ç¡®è®¤åä¸ºå¥åº·ä¸­æœ‰æ•°æ®ä¸”å·²æˆæƒ');
    }
  } catch(e) {
    console.error('Huawei Health error:', e);
    status.innerHTML = `<span style="color:var(--coral)">è¿æ¥å¤±è´¥</span>`;
    btn.textContent = 'é‡è¯•';
    card.classList.remove('connecting');
    showToast('åä¸ºå¥åº·è¿æ¥å¤±è´¥: ' + (e.message || 'æœªçŸ¥é”™è¯¯'));
  }
}

// Toast notification helper
function showToast(msg) {
  let toast = document.getElementById('app-toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'app-toast';
    toast.style.cssText = 'position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:var(--text);color:var(--bg);padding:10px 20px;border-radius:20px;font-size:13px;z-index:9999;opacity:0;transition:opacity 0.3s;pointer-events:none;max-width:80%;text-align:center';
    document.body.appendChild(toast);
  }
  toast.textContent = msg;
  toast.style.opacity = '1';
  setTimeout(() => { toast.style.opacity = '0'; }, 3000);
}

// Legacy simulated connection for non-Health-Connect devices (placeholder)
function connectDevice(id) {
  // For non-Health-Connect devices, show coming-soon message
  showToast(`${id} æ¥å£æ­£åœ¨å¼€å‘ä¸­ï¼Œè¯·ä½¿ç”¨ Health Connect æˆ–æ‰‹åŠ¨å½•å…¥`);
}

function addToHistory(data) {
  const today = todayKey();
  for(const k of Object.keys(data)) {
    if(!healthHistory[k]) healthHistory[k] = [];
    healthHistory[k].push({ date: today, value: data[k] });
    if(healthHistory[k].length > 30) healthHistory[k] = healthHistory[k].slice(-30);
  }
  saveData(LS_HEALTH_HISTORY, healthHistory);
}

function getSparklineData(key) {
  const hist = healthHistory[key] || [];
  if(hist.length >= 2) return hist.slice(-14).map(h => h.value);
  // Generate fake 7-day data
  const base = healthData[key] || metrics.find(m=>m.key===key)?.range[0] || 50;
  const arr = [];
  for(let i=0;i<7;i++) arr.push(base * (0.9 + Math.random()*0.2));
  return arr;
}

function getTrend(key) {
  const data = getSparklineData(key);
  if(data.length < 2) return 'stable';
  const last = data[data.length-1], prev = data[data.length-2];
  const diff = (last - prev) / (prev || 1);
  if(diff > 0.02) return 'up';
  if(diff < -0.02) return 'down';
  return 'stable';
}

function drawSparkline(canvasId, data, color) {
  const canvas = document.getElementById(canvasId);
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.width = canvas.parentElement.offsetWidth;
  const h = canvas.height = 32;
  ctx.clearRect(0,0,w,h);
  if(data.length < 2) return;
  const min = Math.min(...data)*0.95, max = Math.max(...data)*1.05;
  const range = max - min || 1;
  const step = w / (data.length - 1);
  const points = data.map((v,i) => ({ x: i*step, y: h - ((v-min)/range)*h*0.85 - h*0.05 }));
  // Gradient fill
  const grad = ctx.createLinearGradient(0,0,0,h);
  grad.addColorStop(0, color.replace(')', ',0.3)').replace('rgb','rgba').replace('var(--',''));
  grad.addColorStop(1, 'rgba(0,0,0,0)');
  // Parse CSS color
  ctx.beginPath();
  ctx.moveTo(points[0].x, points[0].y);
  for(let i=1;i<points.length;i++) {
    const prev = points[i-1], curr = points[i];
    const cpx1 = prev.x + step*0.4, cpx2 = curr.x - step*0.4;
    ctx.bezierCurveTo(cpx1, prev.y, cpx2, curr.y, curr.x, curr.y);
  }
  // Fill
  ctx.lineTo(points[points.length-1].x, h);
  ctx.lineTo(points[0].x, h);
  ctx.closePath();
  ctx.fillStyle = 'rgba(120,90,60,0.06)';
  ctx.fill();
  // Line
  ctx.beginPath();
  ctx.moveTo(points[0].x, points[0].y);
  for(let i=1;i<points.length;i++) {
    const prev = points[i-1], curr = points[i];
    const cpx1 = prev.x + step*0.4, cpx2 = curr.x - step*0.4;
    ctx.bezierCurveTo(cpx1, prev.y, cpx2, curr.y, curr.x, curr.y);
  }
  ctx.strokeStyle = getCSSColor(color);
  ctx.lineWidth = 1.5;
  ctx.stroke();
  // End dot
  const last = points[points.length-1];
  ctx.beginPath();
  ctx.arc(last.x, last.y, 2.5, 0, Math.PI*2);
  ctx.fillStyle = getCSSColor(color);
  ctx.fill();
}

function getCSSColor(c) {
  const map = {'var(--cyan)':'#2A9D8F','var(--coral)':'#E76F51','var(--gold)':'#E9A820','var(--green)':'#40916C','var(--purple)':'#7B68A8','var(--lavender)':'#9381BE','var(--orange)':'#E07A3A','var(--blue)':'#4A8FBF'};
  return map[c] || c;
}

function renderMetrics() {
  const grid = document.getElementById('metricsGrid');
  grid.innerHTML = metrics.map((m,i) => {
    const val = healthData[m.key];
    const displayVal = val !== undefined ? val : '--';
    const trend = val !== undefined ? getTrend(m.key) : 'stable';
    const trendIcon = trend === 'up' ? 'â†‘' : trend === 'down' ? 'â†“' : 'â†’';
    const trendColor = m.key === 'steps' || m.key === 'oxygen' ? (trend === 'up' ? 'var(--green)' : trend === 'down' ? 'var(--coral)' : 'var(--text3)') : (trend === 'down' ? 'var(--green)' : trend === 'up' ? 'var(--coral)' : 'var(--text3)');
    let valDisplay = `${displayVal}<span class="metric-unit">${m.unit}</span>`;
    if(m.subkey && healthData[m.subkey] !== undefined) {
      valDisplay = `${displayVal}/${healthData[m.subkey]}<span class="metric-unit">${m.unit}</span>`;
    }
    const now = new Date();
    const timeStr = val !== undefined ? `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')} æ›´æ–°` : '';
    return `<div class="card metric-card">
      <div class="metric-header">
        <div class="metric-icon" style="background:${getCSSColor(m.color)}22">${m.icon}</div>
        <div class="metric-trend" style="color:${trendColor}">${trendIcon}</div>
      </div>
      <div class="metric-value" style="color:${getCSSColor(m.color)}">${valDisplay}</div>
      <div class="metric-label">${m.label}</div>
      <div class="sparkline-wrap"><canvas id="spark-${m.key}"></canvas></div>
      <div class="metric-time">${timeStr}</div>
    </div>`;
  }).join('');
  // Draw sparklines after DOM update
  requestAnimationFrame(() => {
    metrics.forEach(m => {
      if(healthData[m.key] !== undefined) {
        drawSparkline('spark-' + m.key, getSparklineData(m.key), m.color);
      }
    });
  });
}

// Manual Entry
function openManualEntry() {
  document.getElementById('manualModal').classList.add('show');
  // Populate form with existing data
  const fields = ['age','gender','height','weight','steps','heartrate','systolic','diastolic','glucose','oxygen','temp','sleep','exercise'];
  fields.forEach(f => {
    const el = document.getElementById('f-' + f);
    if(el && healthData[f] !== undefined) el.value = healthData[f];
  });
  // Set check groups
  if(healthData.smoking) {
    document.querySelectorAll('#f-smoking .form-check').forEach(b => b.classList.toggle('selected', b.dataset.val === healthData.smoking));
  }
  if(healthData.alcohol) {
    document.querySelectorAll('#f-alcohol .form-check').forEach(b => b.classList.toggle('selected', b.dataset.val === healthData.alcohol));
  }
  if(healthData.family) {
    document.querySelectorAll('#f-family .form-check').forEach(b => b.classList.toggle('selected', healthData.family.includes(b.dataset.val)));
  }
}
function closeManualEntry() { document.getElementById('manualModal').classList.remove('show'); }

// Check group handlers
document.querySelectorAll('#f-smoking .form-check').forEach(b => {
  b.addEventListener('click', () => {
    document.querySelectorAll('#f-smoking .form-check').forEach(x => x.classList.remove('selected'));
    b.classList.add('selected');
  });
});
document.querySelectorAll('#f-alcohol .form-check').forEach(b => {
  b.addEventListener('click', () => {
    document.querySelectorAll('#f-alcohol .form-check').forEach(x => x.classList.remove('selected'));
    b.classList.add('selected');
  });
});
document.querySelectorAll('#f-family .form-check').forEach(b => {
  b.addEventListener('click', () => {
    if(b.dataset.val === 'none') {
      document.querySelectorAll('#f-family .form-check').forEach(x => x.classList.remove('selected'));
      b.classList.add('selected');
    } else {
      document.querySelector('#f-family .form-check[data-val="none"]')?.classList.remove('selected');
      b.classList.toggle('selected');
    }
  });
});

function saveManualEntry() {
  const fields = {age:'f-age',gender:'f-gender',height:'f-height',weight:'f-weight',steps:'f-steps',heartrate:'f-heartrate',systolic:'f-systolic',diastolic:'f-diastolic',glucose:'f-glucose',oxygen:'f-oxygen',temp:'f-temp',sleep:'f-sleep',exercise:'f-exercise'};
  const numFields = ['age','height','weight','steps','heartrate','systolic','diastolic','glucose','oxygen','temp','sleep','exercise'];
  for(const [k,id] of Object.entries(fields)) {
    const el = document.getElementById(id);
    if(el && el.value) {
      healthData[k] = numFields.includes(k) ? parseFloat(el.value) : el.value;
    }
  }
  const smokingSel = document.querySelector('#f-smoking .form-check.selected');
  if(smokingSel) healthData.smoking = smokingSel.dataset.val;
  const alcoholSel = document.querySelector('#f-alcohol .form-check.selected');
  if(alcoholSel) healthData.alcohol = alcoholSel.dataset.val;
  const familySel = [...document.querySelectorAll('#f-family .form-check.selected')].map(b => b.dataset.val);
  healthData.family = familySel.includes('none') ? [] : familySel;

  saveData(LS_HEALTH, healthData);
  addToHistory({steps:healthData.steps,heartrate:healthData.heartrate,glucose:healthData.glucose,systolic:healthData.systolic,diastolic:healthData.diastolic,sleep:healthData.sleep,weight:healthData.weight,temp:healthData.temp,oxygen:healthData.oxygen});
  closeManualEntry();
  renderMetrics();
}
// ============================================================
// TAB 2: AI ANALYSIS - Prediction Algorithm
// ============================================================
function calcPrediction() {
  const d = healthData;
  if(!d.age || !d.gender) return null;

  let base = d.gender === 'female' ? 81 : 76;

  // BMI
  let bmi = null;
  if(d.height && d.weight) {
    bmi = d.weight / ((d.height/100)**2);
    if(bmi >= 18.5 && bmi <= 23.9) base += 2;
    else if(bmi >= 24 && bmi <= 27.9) base -= 1;
    else if(bmi >= 28) base -= 3;
    else if(bmi < 18.5) base -= 1;
  }

  // Exercise
  const ex = d.exercise || 0;
  if(ex < 60) base -= 3;
  else if(ex < 150) base -= 1;
  else if(ex <= 300) base += 2;
  else base += 3;

  // Smoking
  const smokingMap = {never:0, quit:-1, occasional:-3, frequent:-7};
  base += smokingMap[d.smoking] || 0;

  // Alcohol
  const alcoholMap = {never:0, occasional:-0.5, frequent:-4};
  base += alcoholMap[d.alcohol] || 0;

  // Blood pressure
  const sys = d.systolic || 120;
  if(sys < 120) base += 1;
  else if(sys < 130) base -= 0;
  else if(sys < 140) base -= 1;
  else if(sys < 160) base -= 3;
  else base -= 5;

  // Blood glucose
  const glu = d.glucose || 5.0;
  if(glu < 6.1) base += 1;
  else if(glu < 7.0) base -= 2;
  else base -= 5;

  // Sleep
  const sl = d.sleep || 7;
  if(sl >= 7 && sl <= 8) base += 1;
  else if((sl >= 6 && sl < 7) || (sl > 8 && sl <= 9)) base += 0;
  else base -= 2;

  // Heart rate
  const hr = d.heartrate || 72;
  if(hr >= 60 && hr <= 80) base += 1;
  else if((hr >= 50 && hr < 60) || (hr > 80 && hr <= 90)) base += 0;
  else base -= 2;

  // Blood oxygen
  const ox = d.oxygen || 98;
  if(ox > 95) base += 0;
  else if(ox >= 90) base -= 1;
  else base -= 3;

  // Family history
  const fam = d.family || [];
  base -= fam.length;

  // Age adjustment: younger people benefit more
  const ageAdj = Math.max(0, (50 - d.age) / 50) * 1.5;
  base += ageAdj;

  const remaining = Math.max(1, Math.round(base - d.age));
  const predicted = d.age + remaining;
  const low = predicted - 4;
  const high = predicted + 4;

  return { predicted, remaining, low, high, bmi, base };
}

function calcHealthScore() {
  const d = healthData;
  if(!d.age) return { total:0, cardio:0, metabolic:0, fitness:0, sleepQ:0, lifestyle:0 };

  // Cardiovascular (BP, HR, exercise, smoking)
  let cardio = 80;
  const sys = d.systolic || 120;
  if(sys < 120) cardio += 15; else if(sys < 130) cardio += 5; else if(sys < 140) cardio -= 5; else cardio -= 20;
  const hr = d.heartrate || 72;
  if(hr >= 60 && hr <= 80) cardio += 5; else if(hr > 100 || hr < 50) cardio -= 15;
  if(d.smoking === 'frequent') cardio -= 20; else if(d.smoking === 'occasional') cardio -= 10;
  if((d.exercise||0) >= 150) cardio += 5; else if((d.exercise||0) < 60) cardio -= 10;
  cardio = Math.max(0, Math.min(100, cardio));

  // Metabolic (glucose, BMI, BP)
  let metabolic = 80;
  const glu = d.glucose || 5.0;
  if(glu < 6.1) metabolic += 10; else if(glu < 7.0) metabolic -= 10; else metabolic -= 25;
  if(d.height && d.weight) {
    const bmi = d.weight / ((d.height/100)**2);
    if(bmi >= 18.5 && bmi <= 23.9) metabolic += 10; else if(bmi >= 28) metabolic -= 15; else if(bmi >= 24) metabolic -= 5;
  }
  metabolic = Math.max(0, Math.min(100, metabolic));

  // Fitness (exercise, steps, HR)
  let fitness = 60;
  const ex = d.exercise || 0;
  if(ex >= 300) fitness += 30; else if(ex >= 150) fitness += 20; else if(ex >= 60) fitness += 5; else fitness -= 10;
  const steps = d.steps || 0;
  if(steps >= 10000) fitness += 10; else if(steps >= 7000) fitness += 5; else if(steps < 3000) fitness -= 10;
  fitness = Math.max(0, Math.min(100, fitness));

  // Sleep quality
  let sleepQ = 70;
  const sl = d.sleep || 7;
  if(sl >= 7 && sl <= 8) sleepQ += 25; else if(sl >= 6 && sl <= 9) sleepQ += 10; else sleepQ -= 15;
  sleepQ = Math.max(0, Math.min(100, sleepQ));

  // Lifestyle (smoking, alcohol, exercise)
  let lifestyle = 80;
  if(d.smoking === 'frequent') lifestyle -= 30; else if(d.smoking === 'occasional') lifestyle -= 15; else if(d.smoking === 'quit') lifestyle -= 5;
  if(d.alcohol === 'frequent') lifestyle -= 20; else if(d.alcohol === 'occasional') lifestyle -= 5;
  if(ex >= 150) lifestyle += 10;
  lifestyle = Math.max(0, Math.min(100, lifestyle));

  const total = Math.round((cardio*0.25 + metabolic*0.2 + fitness*0.2 + sleepQ*0.15 + lifestyle*0.2));
  return { total, cardio: Math.round(cardio), metabolic: Math.round(metabolic), fitness: Math.round(fitness), sleepQ: Math.round(sleepQ), lifestyle: Math.round(lifestyle) };
}

function drawRing(canvasId, pct, color, lineWidth, size) {
  const canvas = document.getElementById(canvasId);
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const w = size || canvas.width;
  canvas.width = w; canvas.height = w;
  const cx = w/2, cy = w/2, r = w/2 - lineWidth;
  ctx.clearRect(0,0,w,w);
  // Background
  ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2);
  ctx.strokeStyle = 'rgba(120,90,60,0.08)'; ctx.lineWidth = lineWidth; ctx.stroke();
  // Fill
  if(pct > 0) {
    ctx.beginPath(); ctx.arc(cx,cy,r,-Math.PI/2,-Math.PI/2+Math.PI*2*Math.min(pct,1));
    ctx.strokeStyle = color; ctx.lineWidth = lineWidth; ctx.lineCap = 'round'; ctx.stroke();
  }
}

let lifeClockAngle = 0;
function drawLifeClock(pred) {
  const canvas = document.getElementById('lifeClockCanvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const w = 180;
  canvas.width = w; canvas.height = w;
  const cx = w/2, cy = w/2;
  ctx.clearRect(0,0,w,w);

  // Outer ring bg
  ctx.beginPath(); ctx.arc(cx,cy,82,0,Math.PI*2);
  ctx.strokeStyle = 'rgba(120,90,60,0.06)'; ctx.lineWidth = 8; ctx.stroke();

  if(!pred) return;

  lifeClockAngle += 0.003;
  const pct = healthData.age / pred.predicted;
  const startAngle = -Math.PI/2 + lifeClockAngle;

  // Gradient ring
  const grad = ctx.createConicGradient(startAngle, cx, cy);
  grad.addColorStop(0, '#2A9D8F'); grad.addColorStop(0.3, '#7B68A8'); grad.addColorStop(0.6, '#E76F51'); grad.addColorStop(1, '#2A9D8F');
  ctx.beginPath(); ctx.arc(cx,cy,82,startAngle,startAngle+Math.PI*2*pct);
  ctx.strokeStyle = grad; ctx.lineWidth = 8; ctx.lineCap = 'round'; ctx.stroke();

  // Tick marks
  for(let i=0;i<60;i++) {
    const angle = (i/60)*Math.PI*2 - Math.PI/2;
    const inner = i%5===0 ? 68 : 72;
    const outer = 76;
    ctx.beginPath();
    ctx.moveTo(cx + Math.cos(angle)*inner, cy + Math.sin(angle)*inner);
    ctx.lineTo(cx + Math.cos(angle)*outer, cy + Math.sin(angle)*outer);
    ctx.strokeStyle = i%5===0 ? 'rgba(58,48,40,0.15)' : 'rgba(58,48,40,0.05)';
    ctx.lineWidth = i%5===0 ? 1.5 : 0.5;
    ctx.stroke();
  }
}

function refreshAITab() {
  const pred = calcPrediction();
  const score = calcHealthScore();

  if(pred) {
    document.getElementById('lifeClockYears').textContent = pred.remaining;
    document.getElementById('lifeExpectText').textContent = `é¢„æœŸå¯¿å‘½: ${pred.low}-${pred.high} å²`;
    drawLifeClock(pred);
  } else {
    document.getElementById('lifeClockYears').textContent = '--';
    document.getElementById('lifeExpectText').textContent = 'è¯·å…ˆå½•å…¥å¥åº·æ•°æ®';
    drawLifeClock(null);
  }

  // Score
  const scoreColor = score.total > 75 ? 'var(--green)' : score.total > 50 ? 'var(--gold)' : 'var(--coral)';
  document.getElementById('scoreValue').textContent = score.total || '--';
  document.getElementById('scoreValue').style.color = getCSSColor(scoreColor);
  drawRing('scoreRingCanvas', score.total/100, getCSSColor(scoreColor), 6, 90);

  // Sub-scores
  const subs = [
    {name:'å¿ƒè¡€ç®¡å¥åº·', val:score.cardio, color:'var(--coral)'},
    {name:'ä»£è°¢å¥åº·', val:score.metabolic, color:'var(--gold)'},
    {name:'è¿åŠ¨ä½“èƒ½', val:score.fitness, color:'var(--green)'},
    {name:'ç¡çœ è´¨é‡', val:score.sleepQ, color:'var(--lavender)'},
    {name:'ç”Ÿæ´»ä¹ æƒ¯', val:score.lifestyle, color:'var(--cyan)'}
  ];
  document.getElementById('scoreBars').innerHTML = subs.map(s =>
    `<div class="score-bar-item"><div class="score-bar-name">${s.name}</div><div class="score-bar-track"><div class="score-bar-fill" style="width:${s.val}%;background:${getCSSColor(s.color)}"></div></div><div class="score-bar-val">${s.val}</div></div>`
  ).join('');
}
// ============================================================
// TAB 2: REPORT GENERATION
// ============================================================
function generateReport() {
  const d = healthData;
  if(!d.age || !d.gender) {
    alert('è¯·å…ˆå½•å…¥åŸºæœ¬å¥åº·æ•°æ®ï¼ˆè‡³å°‘éœ€è¦å¹´é¾„å’Œæ€§åˆ«ï¼‰');
    return;
  }
  document.getElementById('genReportBtn').classList.add('hidden');
  document.getElementById('analyzingWrap').classList.remove('hidden');
  document.getElementById('reportContainer').classList.add('hidden');

  const stages = ['é‡‡é›†æ•°æ®...','åˆ†ææŒ‡æ ‡...','ç”ŸæˆæŠ¥å‘Š...'];
  let si = 0;
  const stageEl = document.getElementById('analyzingStage');
  stageEl.textContent = stages[0];
  const iv = setInterval(() => {
    si++;
    if(si < stages.length) stageEl.textContent = stages[si];
  }, 1000);

  setTimeout(() => {
    clearInterval(iv);
    document.getElementById('analyzingWrap').classList.add('hidden');
    document.getElementById('genReportBtn').classList.remove('hidden');
    buildReport();
    document.getElementById('reportContainer').classList.remove('hidden');
  }, 3000);
}

function buildReport() {
  const d = healthData;
  const pred = calcPrediction();
  const score = calcHealthScore();
  const bmi = d.height && d.weight ? (d.weight / ((d.height/100)**2)).toFixed(1) : null;
  const genderText = d.gender === 'female' ? 'å¥³æ€§' : 'ç”·æ€§';
  const sys = d.systolic || 120;
  const dia = d.diastolic || 80;
  const glu = d.glucose || 5.0;
  const hr = d.heartrate || 72;
  const ox = d.oxygen || 98;
  const sl = d.sleep || 7;
  const steps = d.steps || 0;
  const ex = d.exercise || 0;
  const smokingLabels = {never:'ä»ä¸å¸çƒŸ',quit:'å·²æˆ’çƒŸ',occasional:'å¶å°”å¸çƒŸ',frequent:'ç»å¸¸å¸çƒŸ'};
  const alcoholLabels = {never:'ä»ä¸é¥®é…’',occasional:'å¶å°”é¥®é…’',frequent:'ç»å¸¸é¥®é…’'};
  const smokingText = smokingLabels[d.smoking] || 'æœªçŸ¥';
  const alcoholText = alcoholLabels[d.alcohol] || 'æœªçŸ¥';

  // BP category
  let bpCat = 'æ­£å¸¸';
  if(sys >= 180 || dia >= 120) bpCat = 'é«˜è¡€å‹å±è±¡';
  else if(sys >= 140 || dia >= 90) bpCat = 'é«˜è¡€å‹';
  else if(sys >= 130 || dia >= 85) bpCat = 'åé«˜';
  else if(sys >= 120) bpCat = 'æ­£å¸¸åé«˜';

  // Glucose category
  let gluCat = 'æ­£å¸¸';
  if(glu >= 7.0) gluCat = 'ç³–å°¿ç—…èŒƒå›´';
  else if(glu >= 6.1) gluCat = 'ç³–å°¿ç—…å‰æœŸ';

  // BMI category
  let bmiCat = '';
  if(bmi) {
    if(bmi < 18.5) bmiCat = 'åç˜¦';
    else if(bmi <= 23.9) bmiCat = 'æ­£å¸¸';
    else if(bmi <= 27.9) bmiCat = 'è¶…é‡';
    else bmiCat = 'è‚¥èƒ–';
  }

  let html = '';

  // A) Overall Assessment
  html += `<div class="report-section card"><div class="rs-title">ğŸ“‹ å¥åº·æ€»è¯„</div>`;
  html += `<div class="report-narrative">æ ¹æ®æ‚¨æä¾›çš„å¥åº·æ•°æ®ç»¼åˆåˆ†æï¼Œæ‚¨æ˜¯ä¸€ä½${d.age}å²çš„${genderText}ï¼Œ${bmi ? `å½“å‰BMIä¸º${bmi}ï¼ˆ${bmiCat}ï¼‰` : 'ä½“é‡æ•°æ®æœªæä¾›'}ã€‚æ‚¨çš„æ•´ä½“å¥åº·è¯„åˆ†ä¸º${score.total}åˆ†ï¼ˆæ»¡åˆ†100åˆ†ï¼‰ï¼Œ${score.total >= 75 ? 'å¤„äºè‰¯å¥½æ°´å¹³ï¼Œä½†ä»æœ‰ä¼˜åŒ–ç©ºé—´' : score.total >= 50 ? 'å¤„äºä¸­ç­‰æ°´å¹³ï¼Œå»ºè®®å…³æ³¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è¿›è¡Œæ”¹å–„' : 'å¤„äºéœ€è¦é‡ç‚¹å…³æ³¨çš„æ°´å¹³ï¼Œå»ºè®®å°½å¿«é‡‡å–æ”¹å–„æªæ–½å¹¶å’¨è¯¢åŒ»ç”Ÿ'}ã€‚</div>`;
  html += `<div class="report-narrative">æ‚¨çš„è¡€å‹${sys}/${dia}mmHgï¼ˆ${bpCat}ï¼‰ï¼Œ${bpCat === 'æ­£å¸¸' ? 'å¤„äºç†æƒ³èŒƒå›´å†…' : 'å»ºè®®å®šæœŸç›‘æµ‹å¹¶æ³¨æ„é¥®é£Ÿè°ƒæ•´'}ï¼›ç©ºè…¹è¡€ç³–${glu}mmol/Lï¼ˆ${gluCat}ï¼‰ï¼Œ${gluCat === 'æ­£å¸¸' ? 'ç»´æŒåœ¨å¥åº·æ°´å¹³' : 'éœ€è¦æ³¨æ„é¥®é£Ÿæ§åˆ¶å’Œå®šæœŸå¤æŸ¥'}ï¼›é™æ¯å¿ƒç‡${hr}bpmï¼Œ${hr >= 60 && hr <= 80 ? 'å¤„äºæ­£å¸¸èŒƒå›´' : 'å»ºè®®å…³æ³¨å¿ƒè„å¥åº·'}ï¼›è¡€æ°§é¥±å’Œåº¦${ox}%ï¼Œ${ox >= 95 ? 'æ­£å¸¸' : 'åä½ï¼Œå»ºè®®è¿›ä¸€æ­¥æ£€æŸ¥'}ã€‚</div>`;
  html += `<div class="report-narrative">ç”Ÿæ´»ä¹ æƒ¯æ–¹é¢ï¼Œæ‚¨${smokingText}ï¼Œ${alcoholText}ï¼Œæ¯å‘¨è¿åŠ¨${ex}åˆ†é’Ÿ${ex >= 150 ? 'ï¼Œè¾¾åˆ°äº†WHOæ¨èæ ‡å‡†' : 'ï¼Œæœªè¾¾åˆ°WHOæ¨èçš„æ¯å‘¨150åˆ†é’Ÿä¸­ç­‰å¼ºåº¦è¿åŠ¨æ ‡å‡†'}ã€‚æ¯æ—¥æ­¥æ•°${steps}æ­¥ï¼Œ${steps >= 8000 ? 'ä¿æŒäº†è‰¯å¥½çš„æ—¥å¸¸æ´»åŠ¨é‡' : 'å»ºè®®å¢åŠ æ—¥å¸¸æ­¥è¡Œé‡'}ã€‚ç¡çœ æ—¶é•¿${sl}å°æ—¶ï¼Œ${sl >= 7 && sl <= 8 ? 'å¤„äºç†æƒ³èŒƒå›´' : 'å»ºè®®è°ƒæ•´è‡³7-8å°æ—¶'}ã€‚${(d.family||[]).length > 0 ? 'è€ƒè™‘åˆ°æ‚¨çš„å®¶æ—ç—…å²ï¼ˆ' + d.family.map(f=>({hypertension:'é«˜è¡€å‹',diabetes:'ç³–å°¿ç—…',heart:'å¿ƒè„ç—…',cancer:'ç™Œç—‡'}[f]||f)).join('ã€') + 'ï¼‰ï¼Œéœ€è¦æ›´åŠ é‡è§†ç›¸å…³æŒ‡æ ‡çš„ç›‘æµ‹ã€‚' : ''}</div>`;
  html += `</div>`;

  // B) Metric Details
  html += `<div class="report-section card"><div class="rs-title">ğŸ“Š æŒ‡æ ‡è¯¦è§£</div>`;
  const metricDetails = [
    { name:'è¡€å‹', val:`${sys}/${dia}`, unit:'mmHg', normal:'<120/80', warn:'120-139/80-89', danger:'>=140/90', current:sys, min:80, max:200, normMin:90, normMax:120, warnMax:140 },
    { name:'ç©ºè…¹è¡€ç³–', val:glu, unit:'mmol/L', normal:'3.9-6.1', warn:'6.1-7.0', danger:'>=7.0', current:glu, min:3, max:12, normMin:3.9, normMax:6.1, warnMax:7.0 },
    { name:'å¿ƒç‡', val:hr, unit:'bpm', normal:'60-100', warn:'50-60/100-110', danger:'<50/>110', current:hr, min:40, max:130, normMin:60, normMax:100, warnMax:110 },
    { name:'è¡€æ°§', val:ox, unit:'%', normal:'95-100', warn:'90-95', danger:'<90', current:ox, min:80, max:100, normMin:95, normMax:100, warnMax:95 },
    { name:'ä½“æ¸©', val:d.temp||36.5, unit:'Â°C', normal:'36.1-37.2', warn:'37.3-38.0', danger:'>38.0', current:d.temp||36.5, min:35, max:40, normMin:36.1, normMax:37.2, warnMax:38 },
    { name:'ç¡çœ ', val:sl, unit:'å°æ—¶', normal:'7-9', warn:'6-7', danger:'<6/>10', current:sl, min:3, max:12, normMin:7, normMax:9, warnMax:10 }
  ];
  if(bmi) metricDetails.push({ name:'BMI', val:bmi, unit:'kg/mÂ²', normal:'18.5-23.9', warn:'24-27.9', danger:'>=28', current:parseFloat(bmi), min:14, max:40, normMin:18.5, normMax:23.9, warnMax:28 });

  metricDetails.forEach(m => {
    const pct = ((m.current - m.min) / (m.max - m.min)) * 100;
    const inNormal = m.current >= m.normMin && m.current <= m.normMax;
    const trend = getTrend(m.name === 'è¡€å‹' ? 'systolic' : m.name === 'ç©ºè…¹è¡€ç³–' ? 'glucose' : m.name === 'å¿ƒç‡' ? 'heartrate' : m.name === 'è¡€æ°§' ? 'oxygen' : m.name === 'ä½“æ¸©' ? 'temp' : m.name === 'ç¡çœ ' ? 'sleep' : 'weight');
    const trendText = trend === 'up' ? 'ä¸Šå‡è¶‹åŠ¿' : trend === 'down' ? 'ä¸‹é™è¶‹åŠ¿' : 'ä¿æŒç¨³å®š';
    const statusColor = inNormal ? 'var(--green)' : m.current > m.warnMax ? 'var(--coral)' : 'var(--gold)';
    html += `<div style="margin-bottom:12px;padding:8px 0;border-bottom:1px solid var(--glass-border)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
        <span style="font-size:13px;font-weight:600">${m.name}</span>
        <span style="font-size:14px;font-family:var(--mono);font-weight:700;color:${getCSSColor(statusColor)}">${m.val} ${m.unit}</span>
      </div>
      <div class="range-indicator"><div class="range-bar"><div class="range-marker" style="left:${Math.max(2,Math.min(98,pct))}%"></div></div>
        <div class="range-labels"><span>${m.min}</span><span style="color:var(--green)">æ­£å¸¸: ${m.normal}</span><span>${m.max}</span></div>
      </div>
      <div style="font-size:11px;color:var(--text2);margin-top:4px">è¶‹åŠ¿: ${trendText} | ${inNormal ? 'âœ… å¤„äºæ­£å¸¸èŒƒå›´å†…' : 'âš ï¸ åç¦»æ­£å¸¸èŒƒå›´ï¼Œå»ºè®®å…³æ³¨'}</div>
    </div>`;
  });
  html += `</div>`;

  // C) Risk Factor Analysis
  html += `<div class="report-section"><div class="rs-title" style="margin-top:14px">âš ï¸ é£é™©å› ç´ åˆ†æ</div>`;

  function assessRisk(name, factors, systems, desc, action) {
    let severity = 0;
    factors.forEach(f => severity += f);
    let level, cls, badge;
    if(severity >= 5) { level = 'é«˜é£é™©'; cls = 'risk-high'; badge = 'é«˜'; }
    else if(severity >= 3) { level = 'ä¸­é£é™©'; cls = 'risk-medium'; badge = 'ä¸­'; }
    else if(severity >= 1) { level = 'éœ€å…³æ³¨'; cls = 'risk-watch'; badge = 'å…³æ³¨'; }
    else { level = 'æ­£å¸¸'; cls = 'risk-normal'; badge = 'æ­£å¸¸'; }
    return `<div class="card risk-card ${cls}"><div class="risk-header"><span class="risk-name">${name}</span><span class="risk-badge">${badge}</span></div><div class="risk-desc">${desc}</div><div class="risk-systems">ç›¸å…³ç³»ç»Ÿ: ${systems}</div><div class="risk-action">å»ºè®®: ${action}</div></div>`;
  }

  // Cardiovascular
  let cvFactors = [];
  if(sys >= 140) cvFactors.push(3); else if(sys >= 130) cvFactors.push(1);
  if(d.smoking === 'frequent') cvFactors.push(3); else if(d.smoking === 'occasional') cvFactors.push(1);
  if(bmi && parseFloat(bmi) >= 28) cvFactors.push(2); else if(bmi && parseFloat(bmi) >= 24) cvFactors.push(1);
  if(ex < 60) cvFactors.push(1);
  if(hr > 100) cvFactors.push(1);
  if((d.family||[]).includes('heart') || (d.family||[]).includes('hypertension')) cvFactors.push(2);
  if(glu >= 6.1) cvFactors.push(1);
  const cvTotal = cvFactors.reduce((a,b)=>a+b,0);
  html += assessRisk('å¿ƒè¡€ç®¡é£é™©', cvFactors, 'å¿ƒè„ã€è¡€ç®¡ã€è„‘è¡€ç®¡',
    `æ‚¨çš„è¡€å‹ä¸º${sys}/${dia}mmHgï¼ˆ${bpCat}ï¼‰ï¼Œå¿ƒç‡${hr}bpmï¼Œ${d.smoking === 'frequent' ? 'åŠ ä¸Šç»å¸¸å¸çƒŸçš„ä¹ æƒ¯ï¼Œ' : ''}${glu >= 6.1 ? 'è¡€ç³–åé«˜è¿›ä¸€æ­¥å¢åŠ äº†é£é™©ï¼Œ' : ''}${cvTotal >= 5 ? 'ç»¼åˆè¯„ä¼°æ˜¾ç¤ºå¿ƒè¡€ç®¡é£é™©è¾ƒé«˜ï¼Œå¤šä¸ªé£é™©å› ç´ å åŠ å¯èƒ½æ˜¾è‘—å¢åŠ å¿ƒè„‘è¡€ç®¡äº‹ä»¶çš„å‘ç”Ÿæ¦‚ç‡ã€‚' : cvTotal >= 3 ? 'å­˜åœ¨ä¸€å®šçš„å¿ƒè¡€ç®¡é£é™©å› ç´ ï¼Œå»ºè®®ç§¯æå¹²é¢„å¯æ§å› ç´ ã€‚' : cvTotal >= 1 ? 'å¿ƒè¡€ç®¡é£é™©æ€»ä½“å¯æ§ï¼Œä½†ä»éœ€ä¿æŒå¥åº·ç”Ÿæ´»æ–¹å¼ã€‚' : 'å¿ƒè¡€ç®¡æŒ‡æ ‡è‰¯å¥½ï¼Œè¯·ç»§ç»­ä¿æŒã€‚'}`,
    cvTotal >= 3 ? 'å»ºè®®è¿›è¡Œå¿ƒç”µå›¾å’Œè¡€è„‚å…¨å¥—æ£€æŸ¥ï¼Œæ§åˆ¶è¡€å‹å’Œè¡€ç³–ï¼Œå¢åŠ æœ‰æ°§è¿åŠ¨ã€‚' : 'ä¿æŒå½“å‰è‰¯å¥½ä¹ æƒ¯ï¼Œå®šæœŸä½“æ£€ã€‚');

  // Metabolic syndrome
  let metaFactors = [];
  if(glu >= 7.0) metaFactors.push(3); else if(glu >= 6.1) metaFactors.push(2);
  if(bmi && parseFloat(bmi) >= 28) metaFactors.push(2); else if(bmi && parseFloat(bmi) >= 24) metaFactors.push(1);
  if(sys >= 140) metaFactors.push(1);
  if((d.family||[]).includes('diabetes')) metaFactors.push(2);
  html += assessRisk('ä»£è°¢ç»¼åˆå¾é£é™©', metaFactors, 'å†…åˆ†æ³Œç³»ç»Ÿã€èƒ°è…ºã€è‚è„',
    `è¡€ç³–${glu}mmol/Lï¼ˆ${gluCat}ï¼‰ï¼Œ${bmi ? `BMI ${bmi}ï¼ˆ${bmiCat}ï¼‰` : ''}ã€‚${glu >= 6.1 && bmi && parseFloat(bmi) >= 24 ? 'è¡€ç³–åé«˜ä¼´éšè¶…é‡æ˜¯ä»£è°¢ç»¼åˆå¾çš„å…¸å‹ç‰¹å¾ï¼Œä¸¤è€…ç›¸äº’åŠ é‡ï¼Œéœ€è¦åŒæ—¶å¹²é¢„ã€‚' : glu >= 6.1 ? 'è¡€ç³–åé«˜éœ€è¦æ³¨æ„é¥®é£Ÿç»“æ„å’Œå®šæœŸç›‘æµ‹ã€‚' : 'ä»£è°¢æŒ‡æ ‡åŸºæœ¬æ­£å¸¸ã€‚'}${(d.family||[]).includes('diabetes') ? 'å®¶æ—ç³–å°¿ç—…å²å¢åŠ äº†æ‚¨çš„æ‚£ç—…é£é™©ã€‚' : ''}`,
    glu >= 6.1 ? 'å»ºè®®è¿›è¡Œç³–åŒ–è¡€çº¢è›‹ç™½æ£€æŸ¥ï¼Œæ§åˆ¶ç¢³æ°´åŒ–åˆç‰©æ‘„å…¥ï¼Œå¢åŠ è¿åŠ¨é‡ã€‚' : 'ä¿æŒå‡è¡¡é¥®é£Ÿå’Œé€‚é‡è¿åŠ¨ã€‚');

  // Respiratory
  let respFactors = [];
  if(ox < 90) respFactors.push(3); else if(ox < 95) respFactors.push(1);
  if(d.smoking === 'frequent') respFactors.push(3); else if(d.smoking === 'occasional') respFactors.push(1);
  html += assessRisk('å‘¼å¸ç³»ç»Ÿé£é™©', respFactors, 'è‚ºã€æ”¯æ°”ç®¡ã€å‘¼å¸é“',
    `è¡€æ°§é¥±å’Œåº¦${ox}%ï¼Œ${ox >= 95 ? 'å¤„äºæ­£å¸¸èŒƒå›´' : 'ä½äºæ­£å¸¸å€¼95%'}ã€‚${d.smoking === 'frequent' ? 'ç»å¸¸å¸çƒŸä¸¥é‡æŸå®³è‚ºåŠŸèƒ½ï¼Œæ˜¯æ…¢æ€§é˜»å¡æ€§è‚ºç—…å’Œè‚ºç™Œçš„ä¸»è¦é£é™©å› ç´ ã€‚' : d.smoking === 'occasional' ? 'å¶å°”å¸çƒŸä¹Ÿä¼šå¯¹è‚ºåŠŸèƒ½é€ æˆç´¯ç§¯æŸå®³ã€‚' : 'ä¸å¸çƒŸæœ‰åŠ©äºç»´æŠ¤å‘¼å¸ç³»ç»Ÿå¥åº·ã€‚'}`,
    d.smoking === 'frequent' || d.smoking === 'occasional' ? 'å¼ºçƒˆå»ºè®®æˆ’çƒŸï¼Œè¿›è¡Œè‚ºåŠŸèƒ½æ£€æŸ¥ã€‚' : 'ä¿æŒè‰¯å¥½çš„ç©ºæ°”è´¨é‡æ„è¯†ï¼Œé¿å…äºŒæ‰‹çƒŸã€‚');

  // Musculoskeletal
  let msFactors = [];
  if(bmi && parseFloat(bmi) >= 28) msFactors.push(2);
  if(ex < 60) msFactors.push(2); else if(ex < 150) msFactors.push(1);
  if(d.age > 50) msFactors.push(1);
  html += assessRisk('éª¨éª¼è‚Œè‚‰é£é™©', msFactors, 'éª¨éª¼ã€å…³èŠ‚ã€è‚Œè‚‰',
    `${bmi && parseFloat(bmi) >= 28 ? 'ä½“é‡è¿‡é‡å¢åŠ äº†å…³èŠ‚è´Ÿæ‹…ï¼Œ' : ''}æ¯å‘¨è¿åŠ¨${ex}åˆ†é’Ÿï¼Œ${ex < 60 ? 'è¿åŠ¨ä¸è¶³ä¼šå¯¼è‡´è‚Œè‚‰æµå¤±å’Œéª¨å¯†åº¦ä¸‹é™ã€‚' : ex < 150 ? 'å»ºè®®é€‚å½“å¢åŠ è¿åŠ¨é‡ä»¥ç»´æŠ¤éª¨éª¼å¥åº·ã€‚' : 'è¿åŠ¨é‡å……è¶³ï¼Œæœ‰åŠ©äºç»´æŒéª¨éª¼å’Œè‚Œè‚‰å¥åº·ã€‚'}${d.age > 50 ? 'éšç€å¹´é¾„å¢é•¿ï¼Œéª¨è´¨ç–æ¾é£é™©å¢åŠ ï¼Œå»ºè®®å…³æ³¨é’™å’Œç»´ç”Ÿç´ Dçš„æ‘„å…¥ã€‚' : ''}`,
    ex < 150 ? 'å¢åŠ åŠ›é‡è®­ç»ƒå’Œè´Ÿé‡è¿åŠ¨ï¼Œè¡¥å……é’™è´¨å’Œç»´ç”Ÿç´ Dã€‚' : 'ç»§ç»­ä¿æŒè§„å¾‹è¿åŠ¨ï¼Œæ³¨æ„è¿åŠ¨ä¸­çš„å…³èŠ‚ä¿æŠ¤ã€‚');

  // Mental health
  let mhFactors = [];
  if(sl < 6 || sl > 9) mhFactors.push(2); else if(sl < 7) mhFactors.push(1);
  if(ex < 60) mhFactors.push(2); else if(ex < 150) mhFactors.push(1);
  html += assessRisk('å¿ƒç†å¥åº·é£é™©', mhFactors, 'ç¥ç»ç³»ç»Ÿã€å†…åˆ†æ³Œç³»ç»Ÿ',
    `ç¡çœ ${sl}å°æ—¶ï¼Œ${sl >= 7 && sl <= 8 ? 'å¤„äºç†æƒ³èŒƒå›´' : sl < 6 ? 'ä¸¥é‡ä¸è¶³ï¼Œå¯èƒ½å½±å“æƒ…ç»ªè°ƒèŠ‚å’Œè®¤çŸ¥åŠŸèƒ½' : sl > 9 ? 'è¿‡é•¿å¯èƒ½ä¸æƒ…ç»ªä½è½ç›¸å…³' : 'ç•¥æœ‰ä¸è¶³'}ã€‚æ¯å‘¨è¿åŠ¨${ex}åˆ†é’Ÿï¼Œ${ex >= 150 ? 'è§„å¾‹è¿åŠ¨æœ‰åŠ©äºé‡Šæ”¾å‹åŠ›å’Œæ”¹å–„æƒ…ç»ªã€‚' : 'è¿åŠ¨ä¸è¶³å¯èƒ½å½±å“å¤§è„‘ç¥ç»é€’è´¨çš„æ­£å¸¸åˆ†æ³Œï¼Œå»ºè®®å¢åŠ è¿åŠ¨ã€‚'}`,
    sl < 7 || ex < 150 ? 'æ”¹å–„ç¡çœ ä¹ æƒ¯ï¼Œå¢åŠ æˆ·å¤–è¿åŠ¨ï¼Œå¿…è¦æ—¶è¿›è¡Œå¿ƒç†å¥åº·ç­›æŸ¥ã€‚' : 'ä¿æŒè§„å¾‹ä½œæ¯å’Œè¿åŠ¨ä¹ æƒ¯ã€‚');

  // Liver
  let liverFactors = [];
  if(d.alcohol === 'frequent') liverFactors.push(3); else if(d.alcohol === 'occasional') liverFactors.push(0.5);
  if(bmi && parseFloat(bmi) >= 28) liverFactors.push(2);
  html += assessRisk('è‚è„é£é™©', liverFactors, 'è‚è„ã€èƒ†å›Š',
    `${alcoholText}ï¼Œ${d.alcohol === 'frequent' ? 'é•¿æœŸå¤§é‡é¥®é…’æ˜¯é…’ç²¾æ€§è‚ç—…çš„ä¸»è¦åŸå› ï¼Œå¯å¯¼è‡´è„‚è‚ªè‚ã€è‚ç¡¬åŒ–ç”šè‡³è‚ç™Œã€‚' : d.alcohol === 'occasional' ? 'é€‚é‡é¥®é…’å¯¹è‚è„å½±å“è¾ƒå°ï¼Œä½†ä»éœ€æ³¨æ„ã€‚' : 'ä¸é¥®é…’æœ‰åˆ©äºè‚è„å¥åº·ã€‚'}${bmi && parseFloat(bmi) >= 28 ? 'è¶…é‡/è‚¥èƒ–å¢åŠ äº†éé…’ç²¾æ€§è„‚è‚ªè‚çš„é£é™©ã€‚' : ''}`,
    d.alcohol === 'frequent' ? 'å¼ºçƒˆå»ºè®®å‡å°‘é¥®é…’é‡ï¼Œè¿›è¡Œè‚åŠŸèƒ½æ£€æŸ¥å’Œè…¹éƒ¨è¶…å£°ã€‚' : 'ä¿æŒå¥åº·ä½“é‡ï¼Œé€‚é‡é¥®é…’ã€‚');

  // Cancer
  let cancerFactors = [];
  if(d.smoking === 'frequent') cancerFactors.push(3); else if(d.smoking === 'occasional') cancerFactors.push(1);
  if(d.alcohol === 'frequent') cancerFactors.push(1);
  if(bmi && parseFloat(bmi) >= 28) cancerFactors.push(1);
  if((d.family||[]).includes('cancer')) cancerFactors.push(3);
  html += assessRisk('ç™Œç—‡é£é™©', cancerFactors, 'å…¨èº«å¤šç³»ç»Ÿ',
    `${d.smoking !== 'never' ? 'å¸çƒŸæ˜¾è‘—å¢åŠ è‚ºç™ŒåŠå¤šç§ç™Œç—‡é£é™©ã€‚' : ''}${d.alcohol === 'frequent' ? 'ç»å¸¸é¥®é…’å¢åŠ è‚ç™Œã€é£Ÿç®¡ç™Œç­‰é£é™©ã€‚' : ''}${bmi && parseFloat(bmi) >= 28 ? 'è‚¥èƒ–ä¸ç»“ç›´è‚ ç™Œã€ä¹³è…ºç™Œç­‰å¤šç§ç™Œç—‡ç›¸å…³ã€‚' : ''}${(d.family||[]).includes('cancer') ? 'å®¶æ—ç™Œç—‡å²æ˜¯é‡è¦çš„é£é™©å› ç´ ï¼Œå»ºè®®åŠ å¼ºç­›æŸ¥ã€‚' : ''}${d.smoking === 'never' && d.alcohol !== 'frequent' && (!bmi || parseFloat(bmi) < 28) && !(d.family||[]).includes('cancer') ? 'å½“å‰æœªå‘ç°æ˜æ˜¾çš„ç™Œç—‡é«˜é£é™©å› ç´ ï¼Œä¿æŒå¥åº·ç”Ÿæ´»æ–¹å¼æ˜¯æœ€å¥½çš„é¢„é˜²ã€‚' : ''}`,
    (d.family||[]).includes('cancer') || d.smoking === 'frequent' ? 'å®šæœŸè¿›è¡Œé˜²ç™Œç­›æŸ¥ï¼Œé’ˆå¯¹æ€§æ£€æŸ¥é«˜é£é™©éƒ¨ä½ã€‚' : 'ä¿æŒå¥åº·ç”Ÿæ´»æ–¹å¼ï¼ŒæŒ‰æ—¶è¿›è¡Œå¸¸è§„ä½“æ£€ã€‚');

  // Immune
  let immuneFactors = [];
  if(sl < 6) immuneFactors.push(2); else if(sl < 7 || sl > 9) immuneFactors.push(1);
  if(ex < 60) immuneFactors.push(1);
  if(d.age > 60) immuneFactors.push(1);
  html += assessRisk('å…ç–«ç³»ç»Ÿé£é™©', immuneFactors, 'å…ç–«ç³»ç»Ÿã€æ·‹å·´ç³»ç»Ÿ',
    `ç¡çœ ${sl}å°æ—¶${sl < 7 ? 'ï¼Œç¡çœ ä¸è¶³ä¼šæ˜¾è‘—å‰Šå¼±å…ç–«åŠŸèƒ½' : 'ï¼Œç¡çœ å……è¶³æœ‰åŠ©äºå…ç–«ç³»ç»Ÿä¿®å¤'}ã€‚è¿åŠ¨é‡${ex >= 150 ? 'å……è¶³ï¼Œè§„å¾‹è¿åŠ¨èƒ½å¢å¼ºå…ç–«åŠ›' : 'ä¸è¶³ï¼Œç¼ºä¹è¿åŠ¨å¯èƒ½é™ä½å…ç–«åŠŸèƒ½'}ã€‚${d.age > 60 ? 'å¹´é¾„å¢é•¿å¯¼è‡´å…ç–«åŠŸèƒ½è‡ªç„¶è¡°é€€ã€‚' : ''}`,
    sl < 7 || ex < 150 ? 'æ”¹å–„ç¡çœ è´¨é‡ï¼Œå¢åŠ é€‚é‡è¿åŠ¨ï¼Œä¿è¯è¥å…»å‡è¡¡ã€‚' : 'ç»§ç»­ä¿æŒè‰¯å¥½çš„ç”Ÿæ´»ä¹ æƒ¯ä»¥ç»´æŠ¤å…ç–«åŠ›ã€‚');

  html += `</div>`;
  document.getElementById('reportContainer').innerHTML = html;

  // Continue building remaining sections
  buildReportPart2(d, pred, score, bmi, bmiCat, sys, dia, glu, hr, ox, sl, steps, ex, genderText, smokingText, alcoholText, bpCat, gluCat);
}
function buildReportPart2(d, pred, score, bmi, bmiCat, sys, dia, glu, hr, ox, sl, steps, ex, genderText, smokingText, alcoholText, bpCat, gluCat) {
  const container = document.getElementById('reportContainer');
  let html = container.innerHTML;

  // D) Personalized Improvement Plan
  html += `<div class="report-section"><div class="rs-title" style="margin-top:14px">ğŸ’¡ ä¸ªæ€§åŒ–æ”¹å–„æ–¹æ¡ˆ</div>`;

  const recs = [];

  // Exercise prescription
  if(ex < 150) {
    recs.push({
      icon: 'ğŸƒ', title: 'è¿åŠ¨å¤„æ–¹', priority: 'urgent', priorityText: 'ç´§æ€¥',
      desc: `æ‚¨ç›®å‰æ¯å‘¨è¿åŠ¨${ex}åˆ†é’Ÿï¼Œè¿œä½äºWHOæ¨èçš„150åˆ†é’Ÿã€‚ç¼ºä¹è¿åŠ¨æ˜¯å¤šç§æ…¢æ€§ç—…çš„é‡è¦é£é™©å› ç´ ï¼Œç›´æ¥å½±å“å¿ƒè¡€ç®¡å¥åº·ã€ä»£è°¢åŠŸèƒ½å’Œå¿ƒç†çŠ¶æ€ã€‚å»ºè®®ä»ä½å¼ºåº¦è¿åŠ¨å¼€å§‹ï¼Œå¦‚å¿«èµ°ã€æ¸¸æ³³ï¼Œé€æ­¥å¢åŠ è¿åŠ¨æ—¶é—´å’Œå¼ºåº¦ã€‚`,
      target: `å°†æ¯å‘¨è¿åŠ¨æ—¶é—´ä»å½“å‰çš„${ex}åˆ†é’Ÿæå‡è‡³150åˆ†é’Ÿä»¥ä¸Š`,
      timeline: 'å»ºè®®åœ¨4-6å‘¨å†…é€æ­¥è¾¾æˆ',
      benefit: 'å¯é™ä½å¿ƒè¡€ç®¡ç–¾ç—…é£é™©30%ï¼Œæ”¹å–„è¡€ç³–æ§åˆ¶ï¼Œæå‡ç¡çœ è´¨é‡'
    });
  } else if(ex < 300) {
    recs.push({
      icon: 'ğŸƒ', title: 'è¿åŠ¨ä¼˜åŒ–', priority: 'recommended', priorityText: 'å»ºè®®',
      desc: `æ‚¨æ¯å‘¨è¿åŠ¨${ex}åˆ†é’Ÿï¼Œå·²è¾¾åŸºæœ¬æ ‡å‡†ã€‚å»ºè®®å¢åŠ åŠ›é‡è®­ç»ƒå’Œé«˜å¼ºåº¦é—´æ­‡è®­ç»ƒï¼ˆHIITï¼‰ï¼Œè¿›ä¸€æ­¥æå‡å¿ƒè‚ºåŠŸèƒ½å’Œè‚Œè‚‰åŠ›é‡ã€‚`,
      target: `å°†æ¯å‘¨è¿åŠ¨æ—¶é—´æå‡è‡³300åˆ†é’Ÿï¼Œå…¶ä¸­åŒ…å«2æ¬¡åŠ›é‡è®­ç»ƒ`,
      timeline: 'å»ºè®®åœ¨2-4å‘¨å†…é€æ­¥è°ƒæ•´',
      benefit: 'å¯è¿›ä¸€æ­¥æ”¹å–„å¿ƒè‚ºåŠŸèƒ½å’Œä½“æˆåˆ†'
    });
  }

  // Diet
  if(bmi && (parseFloat(bmi) >= 24 || glu >= 6.1)) {
    recs.push({
      icon: 'ğŸ¥—', title: 'é¥®é£Ÿè°ƒæ•´', priority: parseFloat(bmi) >= 28 || glu >= 7.0 ? 'urgent' : 'important', priorityText: parseFloat(bmi) >= 28 || glu >= 7.0 ? 'ç´§æ€¥' : 'é‡è¦',
      desc: `${parseFloat(bmi) >= 24 ? `æ‚¨çš„BMIä¸º${bmi}ï¼ˆ${bmiCat}ï¼‰ï¼Œéœ€è¦é€šè¿‡é¥®é£Ÿæ§åˆ¶æ¥ç®¡ç†ä½“é‡ã€‚` : ''}${glu >= 6.1 ? `è¡€ç³–${glu}mmol/Låé«˜ï¼Œå»ºè®®å‡å°‘ç²¾åˆ¶ç¢³æ°´åŒ–åˆç‰©å’Œå«ç³–é£Ÿå“çš„æ‘„å…¥ã€‚` : ''}æ¨èé‡‡ç”¨åœ°ä¸­æµ·é¥®é£Ÿæ¨¡å¼ï¼Œå¢åŠ è”¬èœã€å…¨è°·ç‰©å’Œä¼˜è´¨è›‹ç™½çš„æ¯”ä¾‹ï¼Œå‡å°‘åŠ å·¥é£Ÿå“ã€‚`,
      target: `${parseFloat(bmi) >= 24 ? `å°†ä½“é‡ä»${d.weight}kgå‡è‡³${Math.round(23.5*(d.height/100)**2)}kgï¼ˆBMI 23.5ï¼‰` : ''}${glu >= 6.1 ? 'ï¼Œå°†ç©ºè…¹è¡€ç³–æ§åˆ¶åœ¨6.0mmol/Lä»¥ä¸‹' : ''}`,
      timeline: 'å»ºè®®åœ¨3-6ä¸ªæœˆå†…é€æ­¥å®ç°',
      benefit: 'æ¯å‡é‡5%å¯æ˜¾è‘—æ”¹å–„ä»£è°¢æŒ‡æ ‡ï¼Œé™ä½å¿ƒè¡€ç®¡é£é™©'
    });
  }

  // Sleep
  if(sl < 7 || sl > 9) {
    recs.push({
      icon: 'ğŸ˜´', title: 'ç¡çœ ä¼˜åŒ–', priority: sl < 6 ? 'urgent' : 'important', priorityText: sl < 6 ? 'ç´§æ€¥' : 'é‡è¦',
      desc: `æ‚¨ç›®å‰ç¡çœ ${sl}å°æ—¶ï¼Œ${sl < 7 ? 'ä¸è¶³' : 'è¿‡é•¿'}ã€‚${sl < 7 ? 'ç¡çœ ä¸è¶³ä¼šå½±å“å…ç–«åŠ›ã€è®¤çŸ¥åŠŸèƒ½å’Œæƒ…ç»ªè°ƒèŠ‚ï¼Œå¢åŠ è‚¥èƒ–å’Œå¿ƒè¡€ç®¡ç–¾ç—…é£é™©ã€‚' : 'ç¡çœ è¿‡é•¿å¯èƒ½ä¸æŸäº›å¥åº·é—®é¢˜ç›¸å…³ï¼Œä¹Ÿå¯èƒ½é™ä½ç™½å¤©çš„æ´»åŠ›ã€‚'}å»ºè®®å»ºç«‹è§„å¾‹çš„ç¡çœ ä½œæ¯ï¼Œåˆ›é€ è‰¯å¥½çš„ç¡çœ ç¯å¢ƒã€‚`,
      target: `å°†æ¯æ—¥ç¡çœ æ—¶é—´è°ƒæ•´è‡³7-8å°æ—¶`,
      timeline: 'å»ºè®®åœ¨1-2å‘¨å†…å»ºç«‹æ–°çš„ä½œæ¯è§„å¾‹',
      benefit: 'æ”¹å–„å…ç–«åŠŸèƒ½ã€è®¤çŸ¥è¡¨ç°å’Œæƒ…ç»ªç¨³å®šæ€§'
    });
  }

  // Smoking
  if(d.smoking === 'frequent' || d.smoking === 'occasional') {
    recs.push({
      icon: 'ğŸš­', title: 'æˆ’çƒŸå»ºè®®', priority: 'urgent', priorityText: 'ç´§æ€¥',
      desc: `å¸çƒŸæ˜¯æœ€å¤§çš„å¯é¢„é˜²æ­»äº¡åŸå› ä¹‹ä¸€ã€‚${d.smoking === 'frequent' ? 'ç»å¸¸å¸çƒŸ' : 'å¶å°”å¸çƒŸ'}ä¼šæ˜¾è‘—å¢åŠ è‚ºç™Œã€å¿ƒè¡€ç®¡ç–¾ç—…ã€æ…¢æ€§é˜»å¡æ€§è‚ºç—…ç­‰å¤šç§ç–¾ç—…çš„é£é™©ã€‚æˆ’çƒŸå20åˆ†é’Ÿå†…å¿ƒç‡å’Œè¡€å‹å¼€å§‹æ¢å¤æ­£å¸¸ï¼Œ1å¹´åå¿ƒè„ç—…é£é™©é™ä½ä¸€åŠã€‚`,
      target: `å®Œå…¨æˆ’çƒŸ`,
      timeline: 'å»ºè®®ç«‹å³å¼€å§‹ï¼Œå¯å¯»æ±‚æˆ’çƒŸé—¨è¯Šå¸®åŠ©',
      benefit: `æˆ’çƒŸå¯ä½¿é¢„æœŸå¯¿å‘½å¢åŠ ${d.smoking === 'frequent' ? '5-7' : '2-3'}å¹´`
    });
  }

  // Alcohol
  if(d.alcohol === 'frequent') {
    recs.push({
      icon: 'ğŸ·', title: 'é¥®é…’æ§åˆ¶', priority: 'important', priorityText: 'é‡è¦',
      desc: `ç»å¸¸é¥®é…’å¯¹è‚è„ã€å¿ƒè¡€ç®¡å’Œç¥ç»ç³»ç»Ÿéƒ½æœ‰è´Ÿé¢å½±å“ã€‚å»ºè®®ä¸¥æ ¼é™åˆ¶é¥®é…’é‡ï¼Œç”·æ€§æ¯æ—¥ä¸è¶…è¿‡25gé…’ç²¾ï¼ˆçº¦1ç“¶å•¤é…’æˆ–1ä¸¤ç™½é…’ï¼‰ï¼Œå¥³æ€§å‡åŠã€‚æœ€å¥½çš„é€‰æ‹©æ˜¯ä¸é¥®é…’ã€‚`,
      target: `å°†é¥®é…’é¢‘ç‡é™è‡³å¶å°”æˆ–å®Œå…¨æˆ’é…’`,
      timeline: 'å»ºè®®åœ¨2-4å‘¨å†…é€æ­¥å‡å°‘é¥®é…’é‡',
      benefit: 'é™ä½è‚è„ç–¾ç—…å’Œå¿ƒè¡€ç®¡é£é™©ï¼Œæ”¹å–„ç¡çœ è´¨é‡'
    });
  }

  // BP management
  if(sys >= 130) {
    recs.push({
      icon: 'ğŸ©º', title: 'è¡€å‹ç®¡ç†', priority: sys >= 140 ? 'urgent' : 'important', priorityText: sys >= 140 ? 'ç´§æ€¥' : 'é‡è¦',
      desc: `æ‚¨çš„è¡€å‹${sys}/${dia}mmHgï¼ˆ${bpCat}ï¼‰ï¼Œ${sys >= 140 ? 'å·²è¾¾åˆ°é«˜è¡€å‹æ ‡å‡†ï¼Œéœ€è¦ç§¯æå¹²é¢„ã€‚' : 'å¤„äºåé«˜æ°´å¹³ï¼Œåº”æ³¨æ„é¢„é˜²ã€‚'}å»ºè®®ä½ç›é¥®é£Ÿï¼ˆæ¯æ—¥<5gï¼‰ï¼Œå¢åŠ é’¾çš„æ‘„å…¥ï¼ˆé¦™è•‰ã€æ·±è‰²è”¬èœï¼‰ï¼Œè¿›è¡Œè§„å¾‹æœ‰æ°§è¿åŠ¨ï¼Œç®¡ç†å‹åŠ›ã€‚${sys >= 140 ? 'å»ºè®®åœ¨ç”Ÿæ´»æ–¹å¼å¹²é¢„çš„åŒæ—¶å’¨è¯¢åŒ»ç”Ÿæ˜¯å¦éœ€è¦è¯ç‰©æ²»ç–—ã€‚' : ''}`,
      target: `å°†è¡€å‹æ§åˆ¶åœ¨120/80mmHgä»¥ä¸‹`,
      timeline: sys >= 140 ? 'å»ºè®®ç«‹å³å°±åŒ»ï¼ŒåŒæ—¶å¼€å§‹ç”Ÿæ´»æ–¹å¼è°ƒæ•´' : 'å»ºè®®åœ¨4-8å‘¨å†…è§‚å¯Ÿæ”¹å–„æ•ˆæœ',
      benefit: 'è¡€å‹æ¯é™ä½10mmHgï¼Œå¿ƒè¡€ç®¡äº‹ä»¶é£é™©é™ä½20%'
    });
  }

  // Steps
  if(steps < 8000) {
    recs.push({
      icon: 'ğŸ‘Ÿ', title: 'å¢åŠ æ—¥å¸¸æ´»åŠ¨', priority: 'recommended', priorityText: 'å»ºè®®',
      desc: `æ‚¨æ¯æ—¥æ­¥æ•°${steps}æ­¥ï¼Œç ”ç©¶è¡¨æ˜æ¯æ—¥æ­¥è¡Œ8000-10000æ­¥å¯æ˜¾è‘—é™ä½å…¨å› æ­»äº¡ç‡ã€‚å»ºè®®é€šè¿‡é€šå‹¤æ­¥è¡Œã€åˆä¼‘æ•£æ­¥ã€çˆ¬æ¥¼æ¢¯ç­‰æ–¹å¼å¢åŠ æ—¥å¸¸æ´»åŠ¨é‡ã€‚`,
      target: `å°†æ¯æ—¥æ­¥æ•°ä»å½“å‰çš„${steps}æ­¥æå‡è‡³8000æ­¥`,
      timeline: 'å»ºè®®åœ¨2-4å‘¨å†…é€æ­¥è¾¾æˆ',
      benefit: 'é™ä½å…¨å› æ­»äº¡é£é™©15-20%ï¼Œæ”¹å–„å¿ƒè¡€ç®¡å¥åº·'
    });
  }

  if(recs.length === 0) {
    recs.push({
      icon: 'âœ…', title: 'ä¿æŒå½“å‰çŠ¶æ€', priority: 'recommended', priorityText: 'å»ºè®®',
      desc: 'æ‚¨çš„å„é¡¹æŒ‡æ ‡éƒ½åœ¨æ­£å¸¸èŒƒå›´å†…ï¼Œç”Ÿæ´»ä¹ æƒ¯è‰¯å¥½ã€‚ç»§ç»­ä¿æŒå½“å‰çš„å¥åº·ç”Ÿæ´»æ–¹å¼ï¼Œå®šæœŸä½“æ£€ä»¥ç›‘æµ‹å„é¡¹æŒ‡æ ‡çš„å˜åŒ–ã€‚',
      target: 'ç»´æŒå½“å‰å¥åº·æ°´å¹³',
      timeline: 'æŒç»­æ‰§è¡Œ',
      benefit: 'é•¿æœŸç»´æŒè‰¯å¥½å¥åº·çŠ¶æ€'
    });
  }

  recs.forEach(r => {
    html += `<div class="card rec-card">
      <div class="rec-header"><span class="rec-icon">${r.icon}</span><span class="rec-title">${r.title}</span><span class="rec-priority ${r.priority}">${r.priorityText}</span></div>
      <div class="rec-desc">${r.desc}</div>
      <div class="rec-target">ğŸ¯ ç›®æ ‡: ${r.target}</div>
      <div class="rec-timeline">ğŸ“… æ—¶é—´: ${r.timeline}</div>
      <div class="rec-benefit">âœ¨ é¢„æœŸæ”¶ç›Š: ${r.benefit}</div>
    </div>`;
  });
  html += `</div>`;

  // E) Lifespan Prediction Details
  if(pred) {
    html += `<div class="report-section card" style="margin-top:14px"><div class="rs-title">ğŸ”® å¯¿å‘½é¢„æµ‹è¯¦è§£</div>`;
    html += `<div style="text-align:center;padding:10px 0"><div style="font-size:13px;color:var(--text2)">é¢„æµ‹å¯¿å‘½èŒƒå›´</div><div style="font-family:var(--mono);font-size:36px;font-weight:800;background:linear-gradient(135deg,var(--cyan),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">${pred.low} - ${pred.high} å²</div><div style="font-size:11px;color:var(--text3);margin-top:4px">ç½®ä¿¡åº¦: 65% | åŸºäºå½“å‰å¥åº·æ•°æ®è¯„ä¼°</div></div>`;

    // Waterfall factors
    html += `<div style="margin-top:12px;font-size:13px;font-weight:600;margin-bottom:8px">å½±å“å› ç´ åˆ†æ</div>`;
    const baseAge = d.gender === 'female' ? 81 : 76;
    const factors = [];
    if(bmi) {
      const bmiVal = parseFloat(bmi);
      if(bmiVal >= 18.5 && bmiVal <= 23.9) factors.push({name:'ä½“é‡(BMIæ­£å¸¸)',val:+2});
      else if(bmiVal >= 28) factors.push({name:'ä½“é‡(è‚¥èƒ–)',val:-3});
      else if(bmiVal >= 24) factors.push({name:'ä½“é‡(è¶…é‡)',val:-1});
      else factors.push({name:'ä½“é‡(åç˜¦)',val:-1});
    }
    const exMap = [{min:0,max:60,val:-3,label:'è¿åŠ¨ä¸è¶³'},{min:60,max:150,val:-1,label:'è¿åŠ¨åå°‘'},{min:150,max:300,val:+2,label:'è¿åŠ¨å……è¶³'},{min:300,max:9999,val:+3,label:'è¿åŠ¨ä¼˜ç§€'}];
    const exF = exMap.find(e => ex >= e.min && ex < e.max);
    if(exF) factors.push({name:exF.label, val:exF.val});
    const smokingImpact = {never:0,quit:-1,occasional:-3,frequent:-7};
    if(smokingImpact[d.smoking] !== undefined && smokingImpact[d.smoking] !== 0) factors.push({name:d.smoking==='frequent'?'ç»å¸¸å¸çƒŸ':d.smoking==='occasional'?'å¶å°”å¸çƒŸ':'å·²æˆ’çƒŸ', val:smokingImpact[d.smoking]});
    const alcoholImpact = {never:0,occasional:-0.5,frequent:-4};
    if(alcoholImpact[d.alcohol] !== undefined && alcoholImpact[d.alcohol] !== 0) factors.push({name:d.alcohol==='frequent'?'ç»å¸¸é¥®é…’':'å¶å°”é¥®é…’', val:alcoholImpact[d.alcohol]});
    if(sys < 120) factors.push({name:'è¡€å‹æ­£å¸¸',val:+1}); else if(sys >= 160) factors.push({name:'è¡€å‹å¾ˆé«˜',val:-5}); else if(sys >= 140) factors.push({name:'è¡€å‹åé«˜',val:-3}); else if(sys >= 130) factors.push({name:'è¡€å‹ç•¥é«˜',val:-1});
    if(glu < 6.1) factors.push({name:'è¡€ç³–æ­£å¸¸',val:+1}); else if(glu >= 7.0) factors.push({name:'è¡€ç³–åé«˜',val:-5}); else factors.push({name:'è¡€ç³–ç•¥é«˜',val:-2});
    if(sl >= 7 && sl <= 8) factors.push({name:'ç¡çœ å……è¶³',val:+1}); else if(sl < 6 || sl > 9) factors.push({name:'ç¡çœ å¼‚å¸¸',val:-2});
    if(hr >= 60 && hr <= 80) factors.push({name:'å¿ƒç‡æ­£å¸¸',val:+1}); else if(hr < 50 || hr > 100) factors.push({name:'å¿ƒç‡å¼‚å¸¸',val:-2});
    if((d.family||[]).length > 0) factors.push({name:'å®¶æ—ç—…å²',val:-(d.family||[]).length});

    const maxAbs = Math.max(...factors.map(f=>Math.abs(f.val)),1);
    factors.forEach(f => {
      const barW = Math.abs(f.val)/maxAbs*60;
      html += `<div class="waterfall-item"><div class="wf-label">${f.name}</div><div class="wf-bar-wrap"><div class="wf-bar ${f.val>=0?'positive':'negative'}" style="width:${barW}%"></div></div><div class="wf-value ${f.val>=0?'positive':'negative'}">${f.val>0?'+':''}${f.val}å¹´</div></div>`;
    });

    // Improved scenario
    let improved = pred.predicted;
    if(d.smoking === 'frequent') improved += 5;
    else if(d.smoking === 'occasional') improved += 2;
    if(ex < 150) improved += 3;
    if(sl < 7 || sl > 9) improved += 1.5;
    if(bmi && parseFloat(bmi) >= 24) improved += 2;
    improved = Math.round(improved);

    if(improved > pred.predicted) {
      html += `<div style="margin-top:14px;padding:12px;background:rgba(64,145,108,0.06);border:1px solid rgba(64,145,108,0.15);border-radius:10px"><div style="font-size:13px;font-weight:600;color:var(--green);margin-bottom:4px">ğŸŒŸ æ”¹å–„åé¢„æµ‹</div><div style="font-size:12px;color:var(--text2)">å¦‚æœç§¯ææ”¹å–„ä¸Šè¿°å¯æ§å› ç´ ï¼Œæ‚¨çš„é¢„æœŸå¯¿å‘½å¯æå‡è‡³çº¦ <strong style="color:var(--green)">${improved} å²</strong>ï¼Œæ¯”å½“å‰é¢„æµ‹å¢åŠ  <strong style="color:var(--green)">+${improved - pred.predicted} å¹´</strong>ã€‚</div></div>`;
    }

    // Health trajectory chart
    html += `<div style="margin-top:14px;font-size:13px;font-weight:600;margin-bottom:4px">å¥åº·è½¨è¿¹é¢„æµ‹</div><div class="chart-container"><canvas id="trajectoryChart"></canvas></div>`;
    html += `</div>`;
  }

  // F) Monitoring Recommendations
  html += `<div class="report-section" style="margin-top:14px"><div class="rs-title">ğŸ“… å®šæœŸç›‘æµ‹å»ºè®®</div>`;
  const monitors = [
    { icon:'ğŸ©¸', name:'è¡€å‹', freq: sys >= 140 ? 'æ¯å¤©ç›‘æµ‹' : sys >= 130 ? 'æ¯å‘¨2-3æ¬¡' : 'æ¯æœˆ1æ¬¡' },
    { icon:'ğŸ’§', name:'è¡€ç³–', freq: glu >= 7.0 ? 'æ¯å¤©ç›‘æµ‹' : glu >= 6.1 ? 'æ¯å‘¨1æ¬¡ç©ºè…¹è¡€ç³–' : 'æ¯3ä¸ªæœˆ1æ¬¡' },
    { icon:'â¤ï¸', name:'å¿ƒç‡', freq: 'ä½¿ç”¨ç©¿æˆ´è®¾å¤‡æŒç»­ç›‘æµ‹' },
    { icon:'âš–ï¸', name:'ä½“é‡', freq: 'æ¯å‘¨1æ¬¡ï¼Œå›ºå®šæ—¶é—´' },
    { icon:'ğŸ«', name:'è¡€æ°§', freq: ox < 95 ? 'æ¯å¤©ç›‘æµ‹' : 'æœ‰ä¸é€‚æ—¶æ£€æŸ¥' },
    { icon:'ğŸ˜´', name:'ç¡çœ ', freq: 'ä½¿ç”¨ç©¿æˆ´è®¾å¤‡æŒç»­è¿½è¸ª' }
  ];
  monitors.forEach(m => {
    html += `<div class="card monitor-card"><div class="mon-icon">${m.icon}</div><div class="mon-info"><div class="mon-name">${m.name}</div><div class="mon-freq">${m.freq}</div></div></div>`;
  });

  // Doctor visit
  html += `<div class="card" style="padding:12px;margin-top:8px"><div style="font-size:13px;font-weight:600;margin-bottom:6px">ğŸ¥ å°±åŒ»å»ºè®®</div>`;
  const docReasons = [];
  if(sys >= 140) docReasons.push('è¡€å‹æŒç»­åé«˜ï¼ˆéœ€æ’é™¤é«˜è¡€å‹ï¼‰');
  if(glu >= 6.1) docReasons.push('è¡€ç³–åé«˜ï¼ˆéœ€æ’é™¤ç³–å°¿ç—…ï¼‰');
  if(hr > 100 || hr < 50) docReasons.push('å¿ƒç‡å¼‚å¸¸');
  if(ox < 95) docReasons.push('è¡€æ°§åä½');
  if(docReasons.length > 0) {
    html += `<div style="font-size:12px;color:var(--coral);margin-bottom:4px">âš ï¸ å»ºè®®å°½å¿«å°±åŒ»æ£€æŸ¥ï¼š</div>`;
    docReasons.forEach(r => html += `<div style="font-size:12px;color:var(--text2);padding-left:12px">â€¢ ${r}</div>`);
  } else {
    html += `<div style="font-size:12px;color:var(--green)">âœ… å½“å‰æ— éœ€ç´§æ€¥å°±åŒ»ï¼Œå»ºè®®å®šæœŸä½“æ£€å³å¯ã€‚</div>`;
  }
  html += `</div>`;

  // Screenings
  html += `<div class="card" style="padding:12px;margin-top:8px"><div style="font-size:13px;font-weight:600;margin-bottom:6px">ğŸ”¬ å»ºè®®ä½“æ£€é¡¹ç›®</div>`;
  const screenings = [];
  if(d.age >= 18) screenings.push('è¡€å‹ã€è¡€ç³–ã€è¡€è„‚å…¨å¥—ï¼ˆæ¯å¹´ï¼‰');
  if(d.age >= 40) screenings.push('å¿ƒç”µå›¾ï¼ˆæ¯å¹´ï¼‰');
  if(d.age >= 40 && d.gender === 'male') screenings.push('å‰åˆ—è…ºæ£€æŸ¥ï¼ˆæ¯å¹´ï¼‰');
  if(d.age >= 40 && d.gender === 'female') screenings.push('ä¹³è…ºXçº¿æ£€æŸ¥ï¼ˆæ¯1-2å¹´ï¼‰');
  if(d.age >= 45) screenings.push('è‚ é•œæ£€æŸ¥ï¼ˆæ¯5å¹´ï¼‰');
  if(d.age >= 50) screenings.push('éª¨å¯†åº¦æ£€æŸ¥ï¼ˆæ¯2å¹´ï¼‰');
  if(d.smoking !== 'never' && d.age >= 50) screenings.push('ä½å‰‚é‡CTè‚ºç™Œç­›æŸ¥ï¼ˆæ¯å¹´ï¼‰');
  if((d.family||[]).includes('cancer')) screenings.push('é’ˆå¯¹æ€§è‚¿ç˜¤æ ‡å¿—ç‰©ç­›æŸ¥ï¼ˆæ¯å¹´ï¼‰');
  screenings.push('å¸¸è§„ä½“æ£€ï¼ˆæ¯å¹´ï¼‰');
  screenings.forEach(s => html += `<div style="font-size:12px;color:var(--text2);padding:2px 0 2px 12px">â€¢ ${s}</div>`);
  html += `</div></div>`;

  container.innerHTML = html;

  // Draw trajectory chart after DOM update
  if(pred) {
    requestAnimationFrame(() => drawTrajectoryChart(d, pred, score));
  }
}

function drawTrajectoryChart(d, pred, score) {
  const canvas = document.getElementById('trajectoryChart');
  if(!canvas || typeof Chart === 'undefined') return;

  const currentAge = d.age;
  const years = [];
  const currentScores = [];
  const improvedScores = [];

  for(let y=0; y<=30; y+=5) {
    const age = currentAge + y;
    years.push(age + 'å²');
    // Current trajectory
    const decay = Math.max(20, score.total - y*1.2);
    currentScores.push(Math.round(decay));
    // Improved trajectory
    const improved = Math.max(30, Math.min(95, score.total + 10 - y*0.6));
    improvedScores.push(Math.round(improved));
  }

  new Chart(canvas, {
    type: 'line',
    data: {
      labels: years,
      datasets: [
        { label: 'å½“å‰è¶‹åŠ¿', data: currentScores, borderColor: '#E76F51', backgroundColor: 'rgba(231,111,81,0.1)', fill: true, tension: 0.4, pointRadius: 3, borderWidth: 2 },
        { label: 'æ”¹å–„åè¶‹åŠ¿', data: improvedScores, borderColor: '#40916C', backgroundColor: 'rgba(64,145,108,0.1)', fill: true, tension: 0.4, pointRadius: 3, borderWidth: 2, borderDash: [5,5] }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { labels: { color: 'rgba(58,48,40,0.6)', font: { size: 10 } } } },
      scales: {
        x: { ticks: { color: 'rgba(58,48,40,0.4)', font: { size: 9 } }, grid: { color: 'rgba(120,90,60,0.06)' } },
        y: { min: 0, max: 100, ticks: { color: 'rgba(58,48,40,0.4)', font: { size: 9 } }, grid: { color: 'rgba(120,90,60,0.06)' } }
      }
    }
  });
}
// ============================================================
// TAB 3: TIME MANAGEMENT
// ============================================================
let currentPriority = 'high';
let countdownInterval = null;

function selectPriority(p) {
  currentPriority = p;
  document.querySelectorAll('.priority-opt').forEach(b => b.classList.toggle('active', b.dataset.p === p));
}

function refreshTimeTab() {
  updateDateTime();
  renderTasks();
  if(!countdownInterval) {
    countdownInterval = setInterval(updateDateTime, 1000);
  }
}

function updateDateTime() {
  const now = new Date();
  const weekdays = ['æ˜ŸæœŸæ—¥','æ˜ŸæœŸä¸€','æ˜ŸæœŸäºŒ','æ˜ŸæœŸä¸‰','æ˜ŸæœŸå››','æ˜ŸæœŸäº”','æ˜ŸæœŸå…­'];
  document.getElementById('dateDisplay').textContent = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ ${weekdays[now.getDay()]}`;

  const endOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
  const diff = endOfDay - now;
  const h = Math.floor(diff/3600000);
  const m = Math.floor((diff%3600000)/60000);
  const s = Math.floor((diff%60000)/1000);
  document.getElementById('countdownTime').textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;

  const pct = ((now.getHours()*3600 + now.getMinutes()*60 + now.getSeconds()) / 86400 * 100).toFixed(1);
  document.getElementById('dayPct').textContent = Math.round(pct) + '%';
  drawRing('dayRingCanvas', pct/100, '#2A9D8F', 3, 44);
}

function addTask() {
  const input = document.getElementById('taskInput');
  const text = input.value.trim();
  if(!text) return;
  const tasks = loadTasks();
  tasks.push({ id: Date.now(), text, priority: currentPriority, done: false, time: null });
  saveTasks(tasks);
  input.value = '';
  renderTasks();
}

document.getElementById('taskInput')?.addEventListener('keypress', (e) => {
  if(e.key === 'Enter') addTask();
});

function toggleTask(id) {
  const tasks = loadTasks();
  const t = tasks.find(x => x.id === id);
  if(t) t.done = !t.done;
  saveTasks(tasks);
  renderTasks();
}

function deleteTask(id) {
  let tasks = loadTasks();
  tasks = tasks.filter(x => x.id !== id);
  saveTasks(tasks);
  renderTasks();
}

function renderTasks() {
  const tasks = loadTasks();
  const total = tasks.length;
  const done = tasks.filter(t=>t.done).length;
  const rate = total > 0 ? Math.round(done/total*100) : 0;

  document.getElementById('taskStats').innerHTML = `
    <div class="stat-card"><div class="stat-num" style="color:var(--green)">${done}</div><div class="stat-label">å·²å®Œæˆ</div></div>
    <div class="stat-card"><div class="stat-num" style="color:var(--cyan)">${total}</div><div class="stat-label">æ€»ä»»åŠ¡</div></div>
    <div class="stat-card"><div class="stat-num" style="color:var(--gold)">${rate}%</div><div class="stat-label">å®Œæˆç‡</div></div>
  `;

  const groups = { high:[], med:[], low:[] };
  tasks.filter(t=>!t.done).forEach(t => groups[t.priority]?.push(t));
  const doneTasks = tasks.filter(t=>t.done);

  let html = '';
  const groupInfo = [
    {key:'high', title:'ğŸ”´ é«˜ä¼˜å…ˆçº§', cls:'tg-high'},
    {key:'med', title:'ğŸŸ¡ ä¸­ä¼˜å…ˆçº§', cls:'tg-med'},
    {key:'low', title:'ğŸŸ¢ ä½ä¼˜å…ˆçº§', cls:'tg-low'}
  ];

  groupInfo.forEach(g => {
    if(groups[g.key].length === 0) return;
    html += `<div class="task-group"><div class="task-group-title ${g.cls}">${g.title} (${groups[g.key].length})</div>`;
    groups[g.key].forEach(t => {
      const pCls = t.priority === 'high' ? 'tp-high' : t.priority === 'med' ? 'tp-med' : 'tp-low';
      const pText = t.priority === 'high' ? 'é«˜' : t.priority === 'med' ? 'ä¸­' : 'ä½';
      html += `<div class="task-item"><div class="task-check" onclick="toggleTask(${t.id})"></div><div class="task-text">${t.text}</div><span class="task-priority ${pCls}">${pText}</span><button class="task-del" onclick="deleteTask(${t.id})">âœ•</button></div>`;
    });
    html += `</div>`;
  });

  if(doneTasks.length > 0) {
    html += `<div class="task-group completed-section"><div class="task-group-title" style="background:rgba(120,90,60,0.04);color:var(--text3)">âœ… å·²å®Œæˆ (${doneTasks.length})</div>`;
    doneTasks.forEach(t => {
      html += `<div class="task-item"><div class="task-check checked" onclick="toggleTask(${t.id})"></div><div class="task-text done">${t.text}</div><button class="task-del" onclick="deleteTask(${t.id})">âœ•</button></div>`;
    });
    html += `</div>`;
  }

  if(tasks.length === 0) {
    html = `<div style="text-align:center;padding:30px 0;color:var(--text3)"><div style="font-size:36px;margin-bottom:8px">ğŸ“</div><div style="font-size:13px">æš‚æ— ä»»åŠ¡ï¼Œæ·»åŠ ä¸€ä¸ªå¼€å§‹å§</div></div>`;
  }

  document.getElementById('taskList').innerHTML = html;
}

// ============================================================
// TAB 4: LIFE PLANNING
// ============================================================
const categories = ['å…¨éƒ¨','æ—…è¡Œ','å­¦ä¹ ','äº‹ä¸š','å®¶åº­','å¥åº·','å†’é™©','åˆ›é€ ','ç¤¾äº¤'];
const catEmojis = {'æ—…è¡Œ':'ğŸŒ','å­¦ä¹ ':'ğŸ“š','äº‹ä¸š':'ğŸ’¼','å®¶åº­':'ğŸ ','å¥åº·':'ğŸ’ª','å†’é™©':'ğŸ”','åˆ›é€ ':'ğŸ¨','ç¤¾äº¤':'ğŸ¤'};
const presets = [
  {title:'æ”€ç™»é›ªå±±',cat:'å†’é™©',desc:'æŒ‘æˆ˜ä¸€åº§æµ·æ‹”5000ç±³ä»¥ä¸Šçš„é›ªå±±'},
  {title:'ç¯æ¸¸ä¸–ç•Œ',cat:'æ—…è¡Œ',desc:'èµ°éä¸ƒå¤§æ´²ï¼Œä½“éªŒä¸åŒæ–‡åŒ–'},
  {title:'å­¦ä¹ ä¸€é—¨ä¹å™¨',cat:'å­¦ä¹ ',desc:'ç†Ÿç»ƒæŒæ¡ä¸€ç§ä¹å™¨çš„æ¼”å¥'},
  {title:'å†™ä¸€æœ¬ä¹¦',cat:'åˆ›é€ ',desc:'å®Œæˆä¸€æœ¬å±äºè‡ªå·±çš„è‘—ä½œ'},
  {title:'è·‘å®Œé©¬æ‹‰æ¾',cat:'å¥åº·',desc:'å®Œæˆä¸€åœºå…¨ç¨‹42.195å…¬é‡Œçš„é©¬æ‹‰æ¾'},
  {title:'å­¦ä¼šæ–°è¯­è¨€',cat:'å­¦ä¹ ',desc:'æµåˆ©æŒæ¡ä¸€é—¨æ–°çš„å¤–è¯­'},
  {title:'åˆ›åŠå…¬å¸',cat:'äº‹ä¸š',desc:'åˆ›ç«‹è‡ªå·±çš„ä¼ä¸šï¼Œå®ç°åˆ›ä¸šæ¢¦æƒ³'},
  {title:'æ·±æµ·æ½œæ°´',cat:'å†’é™©',desc:'ä½“éªŒæ·±æµ·æ½œæ°´ï¼Œæ¢ç´¢æµ·åº•ä¸–ç•Œ'},
  {title:'çœ‹æå…‰',cat:'æ—…è¡Œ',desc:'äº²çœ¼è§è¯åŒ—æå…‰çš„å£®ä¸½æ™¯è±¡'},
  {title:'å‚åŠ å¿—æ„¿æœåŠ¡',cat:'ç¤¾äº¤',desc:'å‚ä¸å…¬ç›Šæ´»åŠ¨ï¼Œå›é¦ˆç¤¾ä¼š'},
  {title:'å­¦ä¼šçƒ¹é¥ª',cat:'å­¦ä¹ ',desc:'æŒæ¡è‡³å°‘10é“æ‹¿æ‰‹èœ'},
  {title:'æ‹ä¸€éƒ¨çŸ­ç‰‡',cat:'åˆ›é€ ',desc:'è‡ªç¼–è‡ªå¯¼å®Œæˆä¸€éƒ¨çŸ­ç‰‡ä½œå“'}
];
let currentCat = 'å…¨éƒ¨';

function renderCatFilter() {
  document.getElementById('catFilter').innerHTML = categories.map(c =>
    `<button class="cat-chip ${c===currentCat?'active':''}" onclick="filterCat('${c}')">${c === 'å…¨éƒ¨' ? c : (catEmojis[c]||'') + ' ' + c}</button>`
  ).join('');
}

function filterCat(c) {
  currentCat = c;
  renderCatFilter();
  renderGoals();
}

function renderGoals() {
  const pred = calcPrediction();
  const currentAge = healthData.age || 25;
  const predictedAge = pred ? pred.predicted : 80;
  const remaining = pred ? pred.remaining : 55;

  document.getElementById('remainYears').textContent = remaining;

  const filtered = currentCat === 'å…¨éƒ¨' ? goals : goals.filter(g => g.cat === currentCat);
  const completed = goals.filter(g => g.status === 'done').length;

  // Goal ring
  const pct = goals.length > 0 ? completed / goals.length : 0;
  drawRing('goalRingCanvas', pct, '#40916C', 4, 60);
  document.getElementById('goalRingText').textContent = `${completed}/${goals.length}`;
  document.getElementById('goalProgressText').textContent = goals.length > 0 ? `${completed}/${goals.length} ä¸ªç›®æ ‡å·²å®Œæˆ` : 'å°šæœªè®¾å®šäººç”Ÿç›®æ ‡';

  // Timeline
  const timelineEl = document.getElementById('lifeTimeline');
  const fillPct = ((currentAge - (currentAge > 0 ? currentAge : 20)) / (predictedAge - (currentAge > 0 ? currentAge : 20))) * 100;
  document.getElementById('timelineFill').style.width = '0%'; // At start of remaining life

  // Remove old markers
  timelineEl.querySelectorAll('.timeline-marker').forEach(m => m.remove());
  goals.forEach(g => {
    if(g.targetAge) {
      const pos = ((g.targetAge - currentAge) / (predictedAge - currentAge)) * 100;
      if(pos >= 0 && pos <= 100) {
        const statusColor = g.status === 'done' ? 'var(--green)' : g.status === 'progress' ? 'var(--cyan)' : 'var(--text3)';
        const marker = document.createElement('div');
        marker.className = 'timeline-marker';
        marker.style.left = pos + '%';
        marker.style.background = getCSSColor(statusColor);
        marker.innerHTML = `<div class="tm-label">${g.title}</div>`;
        timelineEl.appendChild(marker);
      }
    }
  });

  // Goal list
  let html = '';
  if(filtered.length === 0) {
    html = `<div style="text-align:center;padding:24px 0;color:var(--text3)"><div style="font-size:32px;margin-bottom:8px">ğŸ¯</div><div style="font-size:13px">${currentCat === 'å…¨éƒ¨' ? 'è¿˜æ²¡æœ‰äººç”Ÿç›®æ ‡ï¼Œå¿«æ¥æ·»åŠ å§' : 'è¯¥ç±»åˆ«ä¸‹æš‚æ— ç›®æ ‡'}</div></div>`;
  } else {
    filtered.forEach(g => {
      const emoji = catEmojis[g.cat] || 'ğŸ¯';
      const statusCls = g.status === 'done' ? 'status-done' : g.status === 'progress' ? 'status-progress' : 'status-pending';
      const statusText = g.status === 'done' ? 'å·²å®Œæˆ' : g.status === 'progress' ? 'è¿›è¡Œä¸­' : 'æœªå¼€å§‹';
      html += `<div class="card goal-card">
        <button class="goal-del" onclick="deleteGoal(${g.id})">âœ•</button>
        <div class="goal-header"><span class="goal-emoji">${emoji}</span><span class="goal-title">${g.title}</span><span class="goal-cat">${g.cat}</span></div>
        ${g.desc ? `<div class="goal-desc">${g.desc}</div>` : ''}
        <div class="goal-footer"><span class="goal-age">ğŸ‚ ç›®æ ‡å¹´é¾„: ${g.targetAge || '--'} å²</span><button class="goal-status ${statusCls}" onclick="cycleGoalStatus(${g.id})">${statusText}</button></div>
      </div>`;
    });
  }
  document.getElementById('goalList').innerHTML = html;
}

function renderPresets() {
  document.getElementById('presetChips').innerHTML = presets.map(p =>
    `<button class="preset-chip" onclick="addPreset('${p.title}','${p.cat}','${p.desc}')">${catEmojis[p.cat]||''} ${p.title}</button>`
  ).join('');
}

function addPreset(title, cat, desc) {
  const currentAge = healthData.age || 25;
  goals.push({ id: Date.now(), title, cat, desc, targetAge: currentAge + Math.floor(Math.random()*20+5), status: 'pending' });
  saveData(LS_GOALS, goals);
  renderGoals();
}

function openGoalModal() { document.getElementById('goalModal').classList.add('show'); }
function closeGoalModal() { document.getElementById('goalModal').classList.remove('show'); }

function saveGoal() {
  const title = document.getElementById('g-title').value.trim();
  if(!title) { alert('è¯·è¾“å…¥ç›®æ ‡åç§°'); return; }
  const cat = document.getElementById('g-cat').value;
  const age = parseInt(document.getElementById('g-age').value) || (healthData.age || 25) + 10;
  const desc = document.getElementById('g-desc').value.trim();
  goals.push({ id: Date.now(), title, cat, desc, targetAge: age, status: 'pending' });
  saveData(LS_GOALS, goals);
  closeGoalModal();
  document.getElementById('g-title').value = '';
  document.getElementById('g-age').value = '';
  document.getElementById('g-desc').value = '';
  renderGoals();
}

function cycleGoalStatus(id) {
  const g = goals.find(x => x.id === id);
  if(!g) return;
  const cycle = ['pending','progress','done'];
  const idx = cycle.indexOf(g.status);
  g.status = cycle[(idx+1)%cycle.length];
  saveData(LS_GOALS, goals);
  renderGoals();
}

function deleteGoal(id) {
  goals = goals.filter(x => x.id !== id);
  saveData(LS_GOALS, goals);
  renderGoals();
}

function refreshLifeTab() {
  renderCatFilter();
  renderGoals();
  renderPresets();
}

// ============================================================
// INIT
// ============================================================
function init() {
  renderDevices();
  renderMetrics();
  refreshTimeTab();

  // Close modals on overlay click
  document.querySelectorAll('.modal-overlay').forEach(m => {
    m.addEventListener('click', (e) => {
      if(e.target === m) m.classList.remove('show');
    });
  });

  // Life clock animation
  let pred = calcPrediction();
  function animateLifeClock() {
    pred = calcPrediction();
    drawLifeClock(pred);
    requestAnimationFrame(animateLifeClock);
  }
  animateLifeClock();
}

// Auth-gated startup: check login before initializing app
checkAuth();
</script>
</div>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"75124c326cb447fe934cde04713ae013","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>
